import*as t from"eventemitter3";import*as e from"blueimp-md5";import*as r from"luxon";import*as i from"rrule";var n={509:(t,e,r)=>{var i=r(9985),n=r(3691),s=TypeError;t.exports=function(t){if(i(t))return t;throw new s(n(t)+" is not a function")}},5027:(t,e,r)=>{var i=r(8999),n=String,s=TypeError;t.exports=function(t){if(i(t))return t;throw new s(n(t)+" is not an object")}},4328:(t,e,r)=>{var i=r(5290),n=r(7578),s=r(6310),a=function(t){return function(e,r,a){var o,h=i(e),c=s(h),u=n(a,c);if(t&&r!=r){for(;c>u;)if((o=h[u++])!=o)return!0}else for(;c>u;u++)if((t||u in h)&&h[u]===r)return t||u||0;return!t&&-1}};t.exports={includes:a(!0),indexOf:a(!1)}},5649:(t,e,r)=>{var i=r(7697),n=r(2297),s=TypeError,a=Object.getOwnPropertyDescriptor,o=i&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(t){return t instanceof TypeError}}();t.exports=o?function(t,e){if(n(t)&&!a(t,"length").writable)throw new s("Cannot set read only .length");return t.length=e}:function(t,e){return t.length=e}},6648:(t,e,r)=>{var i=r(8844),n=i({}.toString),s=i("".slice);t.exports=function(t){return s(n(t),8,-1)}},926:(t,e,r)=>{var i=r(3043),n=r(9985),s=r(6648),a=r(4201)("toStringTag"),o=Object,h="Arguments"===s(function(){return arguments}());t.exports=i?s:function(t){var e,r,i;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=function(t,e){try{return t[e]}catch(t){}}(e=o(t),a))?r:h?s(e):"Object"===(i=s(e))&&n(e.callee)?"Arguments":i}},8758:(t,e,r)=>{var i=r(6812),n=r(9152),s=r(2474),a=r(2560);t.exports=function(t,e,r){for(var o=n(e),h=a.f,c=s.f,u=0;u<o.length;u++){var l=o[u];i(t,l)||r&&i(r,l)||h(t,l,c(e,l))}}},5773:(t,e,r)=>{var i=r(7697),n=r(2560),s=r(5684);t.exports=i?function(t,e,r){return n.f(t,e,s(1,r))}:function(t,e,r){return t[e]=r,t}},5684:t=>{t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},2148:(t,e,r)=>{var i=r(8702),n=r(2560);t.exports=function(t,e,r){return r.get&&i(r.get,e,{getter:!0}),r.set&&i(r.set,e,{setter:!0}),n.f(t,e,r)}},1880:(t,e,r)=>{var i=r(9985),n=r(2560),s=r(8702),a=r(5014);t.exports=function(t,e,r,o){o||(o={});var h=o.enumerable,c=void 0!==o.name?o.name:e;if(i(r)&&s(r,c,o),o.global)h?t[e]=r:a(e,r);else{try{o.unsafe?t[e]&&(h=!0):delete t[e]}catch(t){}h?t[e]=r:n.f(t,e,{value:r,enumerable:!1,configurable:!o.nonConfigurable,writable:!o.nonWritable})}return t}},5014:(t,e,r)=>{var i=r(9037),n=Object.defineProperty;t.exports=function(t,e){try{n(i,t,{value:e,configurable:!0,writable:!0})}catch(r){i[t]=e}return e}},7697:(t,e,r)=>{var i=r(3689);t.exports=!i((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}))},2659:t=>{var e="object"==typeof document&&document.all,r=void 0===e&&void 0!==e;t.exports={all:e,IS_HTMLDDA:r}},6420:(t,e,r)=>{var i=r(9037),n=r(8999),s=i.document,a=n(s)&&n(s.createElement);t.exports=function(t){return a?s.createElement(t):{}}},5565:t=>{var e=TypeError;t.exports=function(t){if(t>9007199254740991)throw e("Maximum allowed index exceeded");return t}},71:t=>{t.exports="undefined"!=typeof navigator&&String(navigator.userAgent)||""},3615:(t,e,r)=>{var i,n,s=r(9037),a=r(71),o=s.process,h=s.Deno,c=o&&o.versions||h&&h.version,u=c&&c.v8;u&&(n=(i=u.split("."))[0]>0&&i[0]<4?1:+(i[0]+i[1])),!n&&a&&(!(i=a.match(/Edge\/(\d+)/))||i[1]>=74)&&(i=a.match(/Chrome\/(\d+)/))&&(n=+i[1]),t.exports=n},2739:t=>{t.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},9989:(t,e,r)=>{var i=r(9037),n=r(2474).f,s=r(5773),a=r(1880),o=r(5014),h=r(8758),c=r(5266);t.exports=function(t,e){var r,u,l,d,p,f=t.target,m=t.global,y=t.stat;if(r=m?i:y?i[f]||o(f,{}):(i[f]||{}).prototype)for(u in e){if(d=e[u],l=t.dontCallGetSet?(p=n(r,u))&&p.value:r[u],!c(m?u:f+(y?".":"#")+u,t.forced)&&void 0!==l){if(typeof d==typeof l)continue;h(d,l)}(t.sham||l&&l.sham)&&s(d,"sham",!0),a(r,u,d,t)}}},3689:t=>{t.exports=function(t){try{return!!t()}catch(t){return!0}}},7215:(t,e,r)=>{var i=r(3689);t.exports=!i((function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")}))},2615:(t,e,r)=>{var i=r(7215),n=Function.prototype.call;t.exports=i?n.bind(n):function(){return n.apply(n,arguments)}},1236:(t,e,r)=>{var i=r(7697),n=r(6812),s=Function.prototype,a=i&&Object.getOwnPropertyDescriptor,o=n(s,"name"),h=o&&"something"===function(){}.name,c=o&&(!i||i&&a(s,"name").configurable);t.exports={EXISTS:o,PROPER:h,CONFIGURABLE:c}},8844:(t,e,r)=>{var i=r(7215),n=Function.prototype,s=n.call,a=i&&n.bind.bind(s,s);t.exports=i?a:function(t){return function(){return s.apply(t,arguments)}}},6058:(t,e,r)=>{var i=r(9037),n=r(9985);t.exports=function(t,e){return arguments.length<2?(r=i[t],n(r)?r:void 0):i[t]&&i[t][e];var r}},4849:(t,e,r)=>{var i=r(509),n=r(981);t.exports=function(t,e){var r=t[e];return n(r)?void 0:i(r)}},9037:function(t,e,r){var i=function(t){return t&&t.Math===Math&&t};t.exports=i("object"==typeof globalThis&&globalThis)||i("object"==typeof window&&window)||i("object"==typeof self&&self)||i("object"==typeof r.g&&r.g)||i("object"==typeof this&&this)||function(){return this}()||Function("return this")()},6812:(t,e,r)=>{var i=r(8844),n=r(690),s=i({}.hasOwnProperty);t.exports=Object.hasOwn||function(t,e){return s(n(t),e)}},7248:t=>{t.exports={}},8506:(t,e,r)=>{var i=r(7697),n=r(3689),s=r(6420);t.exports=!i&&!n((function(){return 7!==Object.defineProperty(s("div"),"a",{get:function(){return 7}}).a}))},4413:(t,e,r)=>{var i=r(8844),n=r(3689),s=r(6648),a=Object,o=i("".split);t.exports=n((function(){return!a("z").propertyIsEnumerable(0)}))?function(t){return"String"===s(t)?o(t,""):a(t)}:a},6738:(t,e,r)=>{var i=r(8844),n=r(9985),s=r(4091),a=i(Function.toString);n(s.inspectSource)||(s.inspectSource=function(t){return a(t)}),t.exports=s.inspectSource},618:(t,e,r)=>{var i,n,s,a=r(9834),o=r(9037),h=r(8999),c=r(5773),u=r(6812),l=r(4091),d=r(2713),p=r(7248),f="Object already initialized",m=o.TypeError,y=o.WeakMap;if(a||l.state){var g=l.state||(l.state=new y);g.get=g.get,g.has=g.has,g.set=g.set,i=function(t,e){if(g.has(t))throw new m(f);return e.facade=t,g.set(t,e),e},n=function(t){return g.get(t)||{}},s=function(t){return g.has(t)}}else{var v=d("state");p[v]=!0,i=function(t,e){if(u(t,v))throw new m(f);return e.facade=t,c(t,v,e),e},n=function(t){return u(t,v)?t[v]:{}},s=function(t){return u(t,v)}}t.exports={set:i,get:n,has:s,enforce:function(t){return s(t)?n(t):i(t,{})},getterFor:function(t){return function(e){var r;if(!h(e)||(r=n(e)).type!==t)throw new m("Incompatible receiver, "+t+" required");return r}}}},2297:(t,e,r)=>{var i=r(6648);t.exports=Array.isArray||function(t){return"Array"===i(t)}},9985:(t,e,r)=>{var i=r(2659),n=i.all;t.exports=i.IS_HTMLDDA?function(t){return"function"==typeof t||t===n}:function(t){return"function"==typeof t}},5266:(t,e,r)=>{var i=r(3689),n=r(9985),s=/#|\.prototype\./,a=function(t,e){var r=h[o(t)];return r===u||r!==c&&(n(e)?i(e):!!e)},o=a.normalize=function(t){return String(t).replace(s,".").toLowerCase()},h=a.data={},c=a.NATIVE="N",u=a.POLYFILL="P";t.exports=a},981:t=>{t.exports=function(t){return null==t}},8999:(t,e,r)=>{var i=r(9985),n=r(2659),s=n.all;t.exports=n.IS_HTMLDDA?function(t){return"object"==typeof t?null!==t:i(t)||t===s}:function(t){return"object"==typeof t?null!==t:i(t)}},3931:t=>{t.exports=!1},734:(t,e,r)=>{var i=r(6058),n=r(9985),s=r(3622),a=r(9525),o=Object;t.exports=a?function(t){return"symbol"==typeof t}:function(t){var e=i("Symbol");return n(e)&&s(e.prototype,o(t))}},6310:(t,e,r)=>{var i=r(3126);t.exports=function(t){return i(t.length)}},8702:(t,e,r)=>{var i=r(8844),n=r(3689),s=r(9985),a=r(6812),o=r(7697),h=r(1236).CONFIGURABLE,c=r(6738),u=r(618),l=u.enforce,d=u.get,p=String,f=Object.defineProperty,m=i("".slice),y=i("".replace),g=i([].join),v=o&&!n((function(){return 8!==f((function(){}),"length",{value:8}).length})),b=String(String).split("String"),w=t.exports=function(t,e,r){"Symbol("===m(p(e),0,7)&&(e="["+y(p(e),/^Symbol\(([^)]*)\)/,"$1")+"]"),r&&r.getter&&(e="get "+e),r&&r.setter&&(e="set "+e),(!a(t,"name")||h&&t.name!==e)&&(o?f(t,"name",{value:e,configurable:!0}):t.name=e),v&&r&&a(r,"arity")&&t.length!==r.arity&&f(t,"length",{value:r.arity});try{r&&a(r,"constructor")&&r.constructor?o&&f(t,"prototype",{writable:!1}):t.prototype&&(t.prototype=void 0)}catch(t){}var i=l(t);return a(i,"source")||(i.source=g(b,"string"==typeof e?e:"")),t};Function.prototype.toString=w((function(){return s(this)&&d(this).source||c(this)}),"toString")},8828:t=>{var e=Math.ceil,r=Math.floor;t.exports=Math.trunc||function(t){var i=+t;return(i>0?r:e)(i)}},2560:(t,e,r)=>{var i=r(7697),n=r(8506),s=r(5648),a=r(5027),o=r(8360),h=TypeError,c=Object.defineProperty,u=Object.getOwnPropertyDescriptor,l="enumerable",d="configurable",p="writable";e.f=i?s?function(t,e,r){if(a(t),e=o(e),a(r),"function"==typeof t&&"prototype"===e&&"value"in r&&p in r&&!r[p]){var i=u(t,e);i&&i[p]&&(t[e]=r.value,r={configurable:d in r?r[d]:i[d],enumerable:l in r?r[l]:i[l],writable:!1})}return c(t,e,r)}:c:function(t,e,r){if(a(t),e=o(e),a(r),n)try{return c(t,e,r)}catch(t){}if("get"in r||"set"in r)throw new h("Accessors not supported");return"value"in r&&(t[e]=r.value),t}},2474:(t,e,r)=>{var i=r(7697),n=r(2615),s=r(9556),a=r(5684),o=r(5290),h=r(8360),c=r(6812),u=r(8506),l=Object.getOwnPropertyDescriptor;e.f=i?l:function(t,e){if(t=o(t),e=h(e),u)try{return l(t,e)}catch(t){}if(c(t,e))return a(!n(s.f,t,e),t[e])}},2741:(t,e,r)=>{var i=r(4948),n=r(2739).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(t){return i(t,n)}},7518:(t,e)=>{e.f=Object.getOwnPropertySymbols},3622:(t,e,r)=>{var i=r(8844);t.exports=i({}.isPrototypeOf)},4948:(t,e,r)=>{var i=r(8844),n=r(6812),s=r(5290),a=r(4328).indexOf,o=r(7248),h=i([].push);t.exports=function(t,e){var r,i=s(t),c=0,u=[];for(r in i)!n(o,r)&&n(i,r)&&h(u,r);for(;e.length>c;)n(i,r=e[c++])&&(~a(u,r)||h(u,r));return u}},9556:(t,e)=>{var r={}.propertyIsEnumerable,i=Object.getOwnPropertyDescriptor,n=i&&!r.call({1:2},1);e.f=n?function(t){var e=i(this,t);return!!e&&e.enumerable}:r},5899:(t,e,r)=>{var i=r(2615),n=r(9985),s=r(8999),a=TypeError;t.exports=function(t,e){var r,o;if("string"===e&&n(r=t.toString)&&!s(o=i(r,t)))return o;if(n(r=t.valueOf)&&!s(o=i(r,t)))return o;if("string"!==e&&n(r=t.toString)&&!s(o=i(r,t)))return o;throw new a("Can't convert object to primitive value")}},9152:(t,e,r)=>{var i=r(6058),n=r(8844),s=r(2741),a=r(7518),o=r(5027),h=n([].concat);t.exports=i("Reflect","ownKeys")||function(t){var e=s.f(o(t)),r=a.f;return r?h(e,r(t)):e}},4684:(t,e,r)=>{var i=r(981),n=TypeError;t.exports=function(t){if(i(t))throw new n("Can't call method on "+t);return t}},2713:(t,e,r)=>{var i=r(3430),n=r(4630),s=i("keys");t.exports=function(t){return s[t]||(s[t]=n(t))}},4091:(t,e,r)=>{var i=r(9037),n=r(5014),s="__core-js_shared__",a=i[s]||n(s,{});t.exports=a},3430:(t,e,r)=>{var i=r(3931),n=r(4091);(t.exports=function(t,e){return n[t]||(n[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.33.3",mode:i?"pure":"global",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.33.3/LICENSE",source:"https://github.com/zloirock/core-js"})},146:(t,e,r)=>{var i=r(3615),n=r(3689),s=r(9037).String;t.exports=!!Object.getOwnPropertySymbols&&!n((function(){var t=Symbol("symbol detection");return!s(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&i&&i<41}))},7578:(t,e,r)=>{var i=r(8700),n=Math.max,s=Math.min;t.exports=function(t,e){var r=i(t);return r<0?n(r+e,0):s(r,e)}},5290:(t,e,r)=>{var i=r(4413),n=r(4684);t.exports=function(t){return i(n(t))}},8700:(t,e,r)=>{var i=r(8828);t.exports=function(t){var e=+t;return e!=e||0===e?0:i(e)}},3126:(t,e,r)=>{var i=r(8700),n=Math.min;t.exports=function(t){return t>0?n(i(t),9007199254740991):0}},690:(t,e,r)=>{var i=r(4684),n=Object;t.exports=function(t){return n(i(t))}},8732:(t,e,r)=>{var i=r(2615),n=r(8999),s=r(734),a=r(4849),o=r(5899),h=r(4201),c=TypeError,u=h("toPrimitive");t.exports=function(t,e){if(!n(t)||s(t))return t;var r,h=a(t,u);if(h){if(void 0===e&&(e="default"),r=i(h,t,e),!n(r)||s(r))return r;throw new c("Can't convert object to primitive value")}return void 0===e&&(e="number"),o(t,e)}},8360:(t,e,r)=>{var i=r(8732),n=r(734);t.exports=function(t){var e=i(t,"string");return n(e)?e:e+""}},3043:(t,e,r)=>{var i={};i[r(4201)("toStringTag")]="z",t.exports="[object z]"===String(i)},4327:(t,e,r)=>{var i=r(926),n=String;t.exports=function(t){if("Symbol"===i(t))throw new TypeError("Cannot convert a Symbol value to a string");return n(t)}},3691:t=>{var e=String;t.exports=function(t){try{return e(t)}catch(t){return"Object"}}},4630:(t,e,r)=>{var i=r(8844),n=0,s=Math.random(),a=i(1..toString);t.exports=function(t){return"Symbol("+(void 0===t?"":t)+")_"+a(++n+s,36)}},9525:(t,e,r)=>{var i=r(146);t.exports=i&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},5648:(t,e,r)=>{var i=r(7697),n=r(3689);t.exports=i&&n((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))},1500:t=>{var e=TypeError;t.exports=function(t,r){if(t<r)throw new e("Not enough arguments");return t}},9834:(t,e,r)=>{var i=r(9037),n=r(9985),s=i.WeakMap;t.exports=n(s)&&/native code/.test(String(s))},4201:(t,e,r)=>{var i=r(9037),n=r(3430),s=r(6812),a=r(4630),o=r(146),h=r(9525),c=i.Symbol,u=n("wks"),l=h?c.for||c:c&&c.withoutSetter||a;t.exports=function(t){return s(u,t)||(u[t]=o&&s(c,t)?c[t]:l("Symbol."+t)),u[t]}},560:(t,e,r)=>{var i=r(9989),n=r(690),s=r(6310),a=r(5649),o=r(5565);i({target:"Array",proto:!0,arity:1,forced:r(3689)((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(t){return t instanceof TypeError}}()},{push:function(t){var e=n(this),r=s(e),i=arguments.length;o(r+i);for(var h=0;h<i;h++)e[r]=arguments[h],r++;return a(e,r),r}})},8858:(t,e,r)=>{var i=r(1880),n=r(8844),s=r(4327),a=r(1500),o=URLSearchParams,h=o.prototype,c=n(h.append),u=n(h.delete),l=n(h.forEach),d=n([].push),p=new o("a=1&a=2&b=3");p.delete("a",1),p.delete("b",void 0),p+""!="a=2"&&i(h,"delete",(function(t){var e=arguments.length,r=e<2?void 0:arguments[1];if(e&&void 0===r)return u(this,t);var i=[];l(this,(function(t,e){d(i,{key:e,value:t})})),a(e,1);for(var n,o=s(t),h=s(r),p=0,f=0,m=!1,y=i.length;p<y;)n=i[p++],m||n.key===o?(m=!0,u(this,n.key)):f++;for(;f<y;)(n=i[f++]).key===o&&n.value===h||c(this,n.key,n.value)}),{enumerable:!0,unsafe:!0})},1318:(t,e,r)=>{var i=r(1880),n=r(8844),s=r(4327),a=r(1500),o=URLSearchParams,h=o.prototype,c=n(h.getAll),u=n(h.has),l=new o("a=1");!l.has("a",2)&&l.has("a",void 0)||i(h,"has",(function(t){var e=arguments.length,r=e<2?void 0:arguments[1];if(e&&void 0===r)return u(this,t);var i=c(this,t);a(e,1);for(var n=s(r),o=0;o<i.length;)if(i[o++]===n)return!0;return!1}),{enumerable:!0,unsafe:!0})},3228:(t,e,r)=>{var i=r(7697),n=r(8844),s=r(2148),a=URLSearchParams.prototype,o=n(a.forEach);i&&!("size"in a)&&s(a,"size",{get:function(){var t=0;return o(this,(function(){t++})),t},configurable:!0,enumerable:!0})}},s={};function a(t){var e=s[t];if(void 0!==e)return e.exports;var r=s[t]={exports:{}};return n[t].call(r.exports,r,r.exports,a),r.exports}a.d=(t,e)=>{for(var r in e)a.o(e,r)&&!a.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var o={};(()=>{a.d(o,{tZ:()=>T,fR:()=>S,ZP:()=>I,O1:()=>O,yQ:()=>P});const n=(t=>{var e={};return a.d(e,t),e})({EventEmitter:()=>t.EventEmitter});const s=(t=>{var e={};return a.d(e,t),e})({default:()=>e.default});const h=class{constructor(t,e){this.si9n=t,this.configure(e)}configure(t){this.defaults={method:"GET",host:"api.si9n.io",basePath:"/v1",path:"",auth:{},cache:!0,...t}}delete(t,e){return this.call({method:"DELETE",path:t,params:e})}get(t,e){return this.call({method:"GET",path:t,params:e})}patch(t,e){return this.call({method:"PATCH",path:t,params:e})}post(t,e){return this.call({method:"POST",path:t,params:e})}put(t,e){return this.call({method:"PUT",path:t,params:e})}call(t){return new Promise(((e,r)=>{if(!t)return r(new Error("props are required"));const i=t?.auth?.type||"device",n=t?.auth?.org||this.si9n.org.id,a=t?.auth?.id||this.si9n.device.id;if(!n&&"user"!==i)return r(new Error("org required"));if(!a&&"user"!==i)return r(new Error(i+" required"));const o=t.method||this.defaults.method,h=t.host||((this.si9n.device?.app?.name||"").toLowerCase().includes("staging")?"dev-api.si9n.io":"")||this.defaults.host,c=(t.basePath||this.defaults.basePath)+(t.path||this.defaults.path);let u="https://"+h+c;t.params&&!["POST","PUT","PATCH"].includes(o)&&(u+=u.includes("?")?"&":"?",u+=Object.keys(t.params).map((e=>encodeURIComponent(e)+"="+encodeURIComponent(t.params[e]))).join("&"));const l=t.auth.key||this.si9n.device.key;if(!l&&"user"!==i)return r(new Error("encryption key is required"));const d=Math.round(3e4*Math.round(Date.now()/3e4)/1e3),p=l&&n+"-"+a+"-"+d+"-"+(0,s.default)(o+"|"+c.split("?")[0]+"|"+d,l),f={method:o,headers:p&&new Headers({Authorization:i+" "+p}),mode:"cors"};"user"===i&&(f.credentials="include"),t.params&&["POST","PUT","PATCH"].includes(o)&&(f.headers.append("Content-Type","application/json"),f.body=JSON.stringify(t.params));if(("cache"in t?t.cache:this.defaults.cache)&&"GET"===o)return this.si9n.cache.get(new Request(u,f)).then(e).catch(r);fetch(u,f).then((t=>{if(204===t?.status)return e();t.text().then((r=>{let i;try{i=JSON.parse(r)}catch(t){}t.status>=400&&(i={status:t.status,...i}),e(i)}))})).catch(r)}))}};a(8858),a(1318),a(3228),a(560);const c=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.name=t.name||"si9n-cache",this.blobUrls={}}url(t,e){const r=!Array.isArray(t);return t&&r&&(t=[t]),t&&t.length?caches.open(e||this.name).then((e=>{const i=t.map((t=>{const r=this.key(t);return this.blobUrls[r]?Promise.resolve(this.blobUrls[r]):e.match(t).then((r=>r?r.blob().then((t=>({type:r.headers.get("Content-Type"),blob:t}))):e.add(t).then((()=>e.match(t))).then((t=>t.blob().then((e=>({type:t.headers.get("Content-Type"),blob:e}))))))).then((t=>{let{type:e,blob:i}=t;return!i.type&&e&&(i=i.slice(0,i.size,e)),this.blobUrls[r]=URL.createObjectURL(i),this.blobUrls[r]})).catch((()=>Promise.resolve()))}));return r?i[0]:Promise.all(i)})):Promise.resolve()}get(t,e,r){return t?new Promise(((i,n)=>{const s=r?setTimeout(n,r):null;fetch(t).then((r=>{if(s&&clearTimeout(s),!r.ok)return n();const a=r.clone();caches.open(e||this.name).then((e=>e.put(t,a))),i(this.formatResponse(r))}),n)})).catch((()=>this.has(t,e))):Promise.resolve()}put(t,e,r){if(!t||!e)return Promise.resolve();const i=new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json; charset=utf-8"}});return caches.open(r||this.name).then((e=>e.put(t,i)))}has(t,e){return t?caches.open(e||this.name).then((e=>e.match(t).then((t=>this.formatResponse(t))))):Promise.resolve()}formatResponse(t){if(!t)return Promise.resolve();return 0===(t.headers.get("Content-Type")||"").indexOf("application/json")?t.text().then((t=>{let e;try{e=JSON.parse(t)}catch(t){}return e})):t}key(t){return"object"==typeof t?t.url:t}keys(t){return caches.open(t||this.name).then((t=>t.keys()))}clear(t){t||(t=[this.name]),Array.isArray(t)||(t=[t]);const e=t.map((t=>caches.delete(t)));return e.push(this.clean()),Promise.all(e)}remove(t,e){return t&&!Array.isArray(t)&&(t=[t]),t&&t.length?caches.open(e||this.name).then((e=>{const r=[];return t.forEach((t=>{r.push(e.delete(t)),r.push(this.clean(t))})),Promise.all(r)})):Promise.resolve()}clean(t){return t&&!Array.isArray(t)&&(t=[t]),t||(t=Object.keys(this.blobUrls)),t.forEach((t=>{const e=this.key(t);this.blobUrls[e]&&(URL.revokeObjectURL(this.blobUrls[e]),delete this.blobUrls[e])})),Promise.resolve()}quota(){return"storage"in navigator&&"estimate"in navigator.storage?navigator.storage.estimate():"webkitTemporaryStorage"in navigator&&"queryUsageAndQuota"in navigator.webkitTemporaryStorage?new Promise(((t,e)=>navigator.webkitTemporaryStorage.queryUsageAndQuota(((e,r)=>t({usage:e,quota:r})),e))):Promise.resolve({usage:0,quota:0})}clearIfQuotaLessThan(t,e){return this.quota().then((r=>{let{usage:i,quota:n}=r;return!n||!i||n-i>=t?Promise.resolve(!1):this.clear(e).then((()=>Promise.resolve(!0)))}))}destroy(){this.clean()}};class u extends n.EventEmitter{constructor(t){super(),this.si9n=t,this.locks={},this.channel=new BroadcastChannel("si9n-shared"),this.channel.addEventListener("message",(t=>{if("update"!==t?.data?.type||!t?.data?.key)return;const e=t.data.key,r="update-"+e;this.listenerCount(r)&&this.get(e).then((t=>this.emit(r,t)))}))}get(t){return this.si9n.cache.has(this.globalizeKey(t))}set(t,e){return this.si9n.cache.put(this.globalizeKey(t),e).then((()=>this.notify(t,e)))}remove(t){return this.si9n.cache.remove(this.globalizeKey(t)).then((()=>this.notify(t,null)))}notify(t,e){this.channel.postMessage({type:"update",key:t}),this.emit("update-"+t,e)}globalizeKey(t){return"/"!==t[0]?"/"+t:t}watch(t,e){const r="update-"+t;this.on(r,e),this.get(t).then((t=>this.emit(r,t)));const i=this;return{stop(){i.off(r,e)}}}lock(t){return this.locks[t]?Promise.resolve(!0):new Promise((e=>{navigator.locks.request(t,{ifAvailable:!0},(r=>r?(this.locks[t]=r,e(!0),new Promise((()=>{}))):e(!1)))}))}destroy(){this.removeAllListeners(),this.locks={},this.channel.close(),this.channel=null}}const l=u;class d extends n.EventEmitter{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.window=t.window||window,this.source=null,this.receive=this.receive.bind(this),this.window.addEventListener("message",this.receive),this.window?.si9n?.webview&&(this.window.si9n.webview.listener=this.receive),this.initiated=Date.now(),this.loaded=null,this.notloaded=null,this.disconnected=null,this.started=null,this.paused=null,this.stopped=!0,this.ignoreOnRepeat=!0,this.repeat=!1,this.org={},this.place={},this.device={},this.display={},this.content={},setTimeout((()=>{this.loaded||(this.notloaded=Date.now(),this.emit("notloaded"),this.emit("ready"))}),400)}get api(){return this._api||(this._api=new h(this)),this._api}get cache(){return this._cache||(this._cache=new c),this._cache}get shared(){return this._shared||(this._shared=new l(this)),this._shared}ready(){return new Promise((t=>{if(this.loaded||this.notloaded)return t();this.once("ready",t)}))}receive(t){if(!t?.data?.type||t.data.type.startsWith("webpack"))return;if(this.source&&t.source&&t.source!==this.source)return;const e=t.data;let r=!1;switch(e.type){case"load":this.loaded=Date.now();case"configure":this.source||t.source===this.window||(this.source=t.source),this.configure(e.data),this.emit(e.type,e),"load"===e.type&&this.emit("ready"),r=!0;break;case"message":"data"===e?.data?.type&&e.data.data&&(this.configure({content:{...this.content,data:e.data.data}}),this.emit(e.type,e),r=!0),"disconnect"===e?.data?.type&&(this.disconnected=Date.now()),"connect"===e?.data?.type&&this.disconnected&&(e.data.data={offlineFor:Date.now()-this.disconnected},this.disconnected=null),"place"===e?.data?.type&&e?.data?.data&&(this.place.current=e.data.data),"display"===e?.data?.type&&e?.data?.data&&this.emit("display",e.data.data),r||(this.emit(e.type,e.data),r=!0);break;case"play":if(this.ignoreOnRepeat&&this.repeat){this.repeat=!1,r=!0;break}if(this.stopped=!1,this.repeat=!1,this.paused){const t=this.paused-this.started;this.started=Date.now()-t,this.paused=0;break}this.started=Date.now();break;case"pause":this.paused=Date.now();break;case"stop":if(this.ignoreOnRepeat&&this.repeat){r=!0;break}if(!e.immediately&&e?.transition?.name&&e.transition.duration){setTimeout((()=>{this.stopped=!0,this.emit("stopped",{type:"stopped"})}),e.transition.duration+32);break}this.stopped=!0,this.emit(e.type,e),this.emit("stopped",{type:"stopped"}),r=!0;break;case"repeat":this.repeat=!0}r||this.emit(e.type,e)}configure(t){if(!t)return;const e=t?.content?.data&&JSON.stringify(t.content.data)!==JSON.stringify(this.content.data);Object.keys(t).forEach((e=>this[e]=t[e])),this.emit("configured",{type:"configured"}),e&&this.content?.template?.fields&&this.emit("data",{type:"data",data:this.content.template.fields.map((t=>({...t,value:this.content.data[t.key]})))})}send(t){this.window?.si9n?.webview?.postMessage?this.window.si9n.webview.postMessage(t):this.source?this.source.postMessage(t,"*"):this.window.parent!==this.window.top&&this.window.parent.postMessage(t,"*"),this.emit("send",t)}get env(){return{previewPlayer:!!this.display.previewPlayer,contentPreview:!!this.display.contentPreview,messageEditing:!!this.display.messageEditing,preview:!!this.display.preview,thumbnail:!!this.display.thumbnail,backgroundApp:!!this.content.runningInBackground,inCalendar:!!this.content.inCalendar,inInterrupt:!!this.content.inInterrupt,inLayout:!!this.content.inLayout,inPlaylist:!!this.content.inPlaylist,inMessage:!!this.content.inMessage}}get now(){return this.display.now||null}get offline(){return!!this.disconnected&&Date.now()-this.disconnected}get time(){return Date.now()-(this.loaded||this.notloaded)}get elapsed(){return this.stopped?0:this.paused?this.paused-this.started:Date.now()-this.started}get playing(){return this.loaded&&!this.stopped&&!this.paused}end(){this.send({type:"end"})}next(){this.send({type:"next"})}prev(){this.send({type:"prev"})}reset(){this.send({type:"reset"})}focus(){this.send({type:"focus"})}printers(){this.send({type:"printers"})}print(t){const e={type:"print",...t&&{data:{printer:t}}};this.send(e)}log(t,e){this.send({type:"log",level:t||"info",data:e})}message(t){this.send({type:"message",data:t})}interrupt(t){this.send({type:"interrupt",data:t})}keepAlive(t){this.send({type:"keepAlive",data:void 0===t||!!t})}skip(t){this.send({type:"skip",data:void 0===t||!!t})}displayMessage(t,e){return new Promise((r=>{this.send({type:"displayMessage",data:t});const i=t=>{t.id&&t.id!==this.display.id||(clearTimeout(n),this.off("display",i),r(t&&t.response))};let n=setTimeout(i,e||1e3);this.on("display",i)}))}serial(t){t?.port&&t?.data?.length&&("string"==typeof t.data&&(t.data=[...(new TextEncoder).encode(t.data)]),this.send({type:"serialMessage",data:t}))}destroy(){this.window.removeEventListener("message",this.receive)}}const p=new d;const f=(t=>{var e={};return a.d(e,t),e})({DateTime:()=>r.DateTime}),m=t=>String("00"+t).slice(-2);function y(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t&&e&&e.zone)return f.DateTime.local().setZone(e.zone);if(!t)return f.DateTime.local();let[r,i=""]=t.replace(" ","T").split("T"),[n,s="",a=""]=r.split("-");if(4!==n.length||s.length>2)return f.DateTime.fromISO(t,e);let o=n;if(s.length&&(o+="-"+m(s)),a.length&&(o+="-"+m(a)),i){const r=i.match(/^([0-2]?\d):?([0-5]?\d?):?([0-5]?\d?)(.*)$/);r||f.DateTime.fromISO(t,e),o+="T"+m(r[1]),r[2].length&&(o+=":"+m(r[2])),r[3].length&&(o+=":"+m(r[3])),r[4].length&&(o+=r[4])}return f.DateTime.fromISO(o,e)}const g=(t=>{var e={};return a.d(e,t),e})({RRule:()=>i.RRule});class v extends n.EventEmitter{constructor(t,e){super(),this.catalogue=t,this.defaults={hoursToLineUp:36},this.data={id:e},this.pricelists=[],this.menus=[],this.timeoutID=null,this.setupTimeoutID=null,this.overrideTimeoutID=null,this.changeTimeoutID=null,this.changeHandler=this.changeHandler.bind(this),this.catalogue.on("change",this.changeHandler),this.offlineHandler=this.offlineHandler.bind(this),p.on("message",this.offlineHandler),p.place?.catalogues?.[this.catalogue.id()]?.scheduleid==e&&(this.placeHandler=this.placeHandler.bind(this),p.on("configured",this.placeHandler)),this.init()}init(){this.watcher&&this.watcher.stop(),this.key="catalogue-schedule-"+this.catalogue.id()+"-"+this.data.id,this.watcher=p.shared.watch(this.key,(t=>{t&&JSON.stringify(t)!==JSON.stringify(this.data)&&(this.data=t,this.setup())})),this.fetch()}changeHandler(t){if(t?.messages?.length){if(t.messages.filter((t=>"Schedule"===t?.model?.type&&t?.model?.id!==this.data.id)).length===t.messages.length)return}this.changeTimeoutID&&clearTimeout(this.changeTimeoutID),this.changeTimeoutID=setTimeout((()=>this.fetch()),Math.floor(1e3*Math.random()*2)+500)}offlineHandler(t){"connect"===t?.type&&t?.data?.offlineFor&&(t.data.offlineFor<6e4||setTimeout(this.changeHandler,Math.floor(1e3*Math.random()*10)))}placeHandler(){if(!this.catalogue)return;const t=p.place?.catalogues?.[this.catalogue.id()]?.scheduleid;this.data.id!==t&&(this.data.id=t,this.init())}at(t){return t&&(this.data.now=t),this}now(){return this.data.now?y(this.data.now,{zone:this.tz()}):p.display.now?y(p.display.now,{zone:this.tz()}):f.DateTime.local().setZone(this.tz())}tz(){return p.place.tz||null}fetch(){return p.shared.lock(this.key).then((t=>{if(t)return Promise.all([this.catalogue.api("/schedules/"+(this.data.id||"default"),{include:"menus",...(this.data.now||p.display.now)&&{date:this.now().toISODate()}}),this.catalogue.overrides({include:"items",...(this.data.now||p.display.now)&&{date:this.now().toISO()}})]).then((t=>p.shared.set(this.key,{now:this.data.now,...this.defaults,...t[0]?.data,overrides:t[1]?.data||[]}))).catch((t=>this.emit("error",t)))}))}setup(){this.setupTimeoutID&&clearTimeout(this.setupTimeoutID),this.setupTimeoutID=setTimeout((()=>this.setup()),60*this.data.hoursToLineUp*60*1e3-3e4);const t=this.now(),e=t.plus({hours:this.data.hoursToLineUp});return this.pricelists=this.itemsForTime((this.data.items||[]).filter((t=>t.active&&t?.pricelist?.id)),t,e),this.menus=this.itemsForTime((this.data.items||[]).filter((t=>t.active&&t?.menu?.id)),t,e,!0),this.resolve()}itemsForTime(t,e,r,i){t=JSON.parse(JSON.stringify(t)),e=e||f.DateTime.local().setZone(this.tz()),r=r||e.plus({days:7}),i=!!i;let n=[];if(t.forEach((t=>{if(t.start=t.start?y(t.start,{zone:this.tz()}):e,t.end&&(t.end=y(t.end,{zone:this.tz()})),t.until&&(t.until=y(t.until,{zone:this.tz()})),"priority"in t||(t.priority=0),!(t.start>r||!t.rrule&&t.end&&t.end<=e))return t.rrule?void this.between(t,e,r).forEach((t=>n.push(t))):n.push(t)})),!n.length)return[];n=n.map(((t,e)=>({...t,idx:e})));const s=(t,e)=>t.start<e.start?-1:t.start>e.start?1:t.priority<e.priority?-1:t.priority>e.priority?1:t.idx<e.idx?-1:t.idx>e.idx?1:0;if(n.sort(s),i)return n;const a=(t,e)=>{if(e.end&&t.start>e.end)return[e];if(t.end&&e.start>t.end)return[e];const r=[];return t.start>e.start&&r.push({...e,end:t.start}),(t.end&&e.end&&t.end<e.end||t.end&&!e.end)&&r.push({...e,start:t.end}),r},o=[];let h=0;for(;h<n.length;){const t=n.length;for(let e=h+1;e<t;e++){const t=n[h],r=a(n[e],t);if(!r.length){const t=n.splice(h,1);o.push(t[0]),h--;break}n[h]=r[0],r.length>1&&n.splice(h+1,0,r[1])}h++}return n=n.map(((t,e)=>({...t,idx:e}))),n.sort(s),o.length?o.concat(n):n}between(t,e,r){const i="yyyyMMdd'T'HHmmss";let n=y(e.toFormat(i),{zone:"utc"});const s=y(r.toFormat(i),{zone:"utc"}),a=y(t.start.toFormat(i),{zone:"utc"}),o=t.end?y(t.end.toFormat(i),{zone:"utc"}):null,h=o?o.diff(a,"seconds").seconds:0;a<n&&(n=n.minus({seconds:h}));let c=t.rrule+";DTSTART="+a.toFormat(i)+"Z";t.until&&(c+=";UNTIL="+t.until.toFormat(i)+"Z");return g.RRule.fromString(c).between(n.toJSDate(),s.toJSDate(),!0).map((e=>{const r={start:y(e.getUTCFullYear()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCDate()+"T"+e.getUTCHours()+":"+e.getUTCMinutes()+":"+e.getUTCSeconds(),{zone:this.tz()})};if(t.end){const t=new Date(e.getTime()+1e3*h);r.end=y(t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate()+"T"+t.getUTCHours()+":"+t.getUTCMinutes()+":"+t.getUTCSeconds(),{zone:this.tz()})}return{...t,...r}}))}resolve(){this.nextResolve();const t=this.now(),e=this.pricelists.filter((e=>e.start<=t&&(!e.end||e.end>t))).shift(),r=e?e.pricelist.id:null,i=this.menus.filter((e=>e.start<=t&&(!e.end||e.end>t)));let n=(this.data.overrides||[]).filter((e=>!e.end||y(e.end)>t));const s=n.reduce(((t,e)=>{if(!e.end)return t;const r=y(e.end);return(!t||r<t)&&(t=r),t}),!1);this.overrideTimeoutID&&clearTimeout(this.overrideTimeoutID),s&&(this.overrideTimeoutID=setTimeout((()=>this.resolve()),s.diff(t).milliseconds)),n=n.reduce(((t,e)=>{t[e.entity]||(t[e.entity]={}),t[e.entity][e.entityid]||(t[e.entity][e.entityid]={});const r={start:e.start};return e.end&&(r.end=e.end),e.attribs&&(r.attribs={...t[e.entity][e.entityid].attribs,...e.attribs}),e.replacement&&(r.replacement=e.replacement),t[e.entity][e.entityid]={...t[e.entity][e.entityid],...r},t}),{}),(this.data.menus||[]).forEach((t=>{const e=JSON.parse(JSON.stringify(t));if(e.id&&n?.Menu?.[e.id]?.attribs&&(e.attribs={...e.attribs,...n.Menu[e.id].attribs}),e?.items?.length&&e.items.forEach((t=>{let e;if(n?.MenuItem?.[t.id]?.attribs&&(t.attribs={...t.attribs,...n.MenuItem[t.id].attribs}),n?.Item?.[t?.item?.id]?.replacement&&(e=n.Item?.[t.item.id].replacement),n?.MenuItem?.[t?.id]?.replacement&&(e=n.MenuItem?.[t.id].replacement),e&&(t.item&&(t.replaces=t.item),t.item=e),!t.item)return;const r=t.item;if(n?.Item?.[r.id]?.attribs&&(r.attribs={...r.attribs,...n.Item[r.id].attribs}),n?.Type?.[r?.type?.id]?.attribs&&(r.type.attribs={...r.type.attribs,...n.Type[r.type.id].attribs}),n?.Brand?.[r?.brand?.id]?.attribs&&(r.brand.attribs={...r.brand.attribs,...n.Brand[r.brand.id].attribs}),r.variants&&r.variants.forEach((t=>{n?.ItemVariant?.[t.id]?.attribs&&(t.attribs={...t.attribs,...n.ItemVariant[t.id].attribs}),t.modifiers&&t.modifiers.forEach((t=>{n?.ItemVariantModifier?.[t.id]&&(t.attribs={...t.attribs,...n.ItemVariantModifier[t.id].attribs})}))})),!r.replaces)return;const i=r.replaces;n?.Item?.[i.id]?.attribs&&(i.attribs={...i.attribs,...n.Item[i.id].attribs}),n?.Type?.[i?.type?.id]?.attribs&&(i.type.attribs={...i.type.attribs,...n.Type[i.type.id].attribs}),n?.Brand?.[i?.brand?.id]?.attribs&&(i.brand.attribs={...i.brand.attribs,...n.Brand[i.brand.id].attribs}),i.variants&&i.variants.forEach((t=>{n?.ItemVariant?.[t.id]?.attribs&&(t.attribs={...t.attribs,...n.ItemVariant[t.id].attribs}),t.modifiers&&t.modifiers.forEach((t=>{n?.ItemVariantModifier?.[t.id]?.attribs&&(t.attribs={...t.attribs,...n.ItemVariantModifier[t.id].attribs})}))}))})),e?.items?.length){const t=(t,e)=>{const r=t.filter((t=>!e&&t.default||t.listid===e));return r.length?r:t.filter((t=>t.default))};e.items.forEach((e=>{e?.item?.variants?.length&&(e.item.variants.forEach((e=>{e?.prices?.length&&(e.prices=t(e.prices,r),e.prices.length||delete e.prices)})),e.replaces&&e.replaces.variants.forEach((e=>{e?.prices?.length&&(e.prices=t(e.prices,r),e.prices.length||delete e.prices)})),e.item.variants.filter((t=>!!t.modifiers)).forEach((e=>{e.modifiers.filter((t=>!!t.variants)).forEach((e=>{e.variants.forEach((e=>{e?.prices?.length&&(e.prices=t(e.prices,r),e.prices.length||delete e.prices)}))}))})))}))}i.filter((t=>t.menu.id===e.id)).forEach((t=>t.menu=e))})),setTimeout((()=>this.emit("slots",i)),0)}nextResolve(){const t=this.now();let e=null;this.pricelists.filter((e=>e.start>t)).forEach((t=>{(!e||e>t.start)&&(e=t.start)})),this.menus.filter((e=>e.start>t)).forEach((t=>{(!e||e>t.start)&&(e=t.start)})),this.pricelists.filter((e=>e.start<=t&&e.end>t)).forEach((t=>{(!e||e>t.end)&&(e=t.end)})),this.menus.filter((e=>e.start<=t&&e.end>t)).forEach((t=>{(!e||e>t.end)&&(e=t.end)})),this.timeoutID&&clearTimeout(this.timeoutID),e&&(this.timeoutID=setTimeout((()=>this.resolve()),e.diff(t).milliseconds))}destroy(){this.timeoutID&&clearTimeout(this.timeoutID),this.setupTimeoutID&&clearTimeout(this.setupTimeoutID),this.overrideTimeoutID&&clearTimeout(this.overrideTimeoutID),this.changeTimeoutID&&clearTimeout(this.changeTimeoutID),this.removeAllListeners(),p.off("configured",this.placeHandler),p.off("message",this.offlineHandler),this.catalogue&&this.catalogue.off("change",this.changeHandler),this.catalogue=null,this.data={},this.pricelists=[],this.menus=[],this.key=null,this.watcher.stop()}}const b=v;class w extends n.EventEmitter{constructor(t){super(),this.configure(t),this.messageHandler=this.messageHandler.bind(this),p.on("message",this.messageHandler)}configure(t){this.cnf={id:"",host:"",path:"",auth:{},...t},this.cnf.id&&!this.cnf.path&&(this.cnf.path="/v1/catalogues/"+this.cnf.id),this.cnf.auth.key||p.device.key||(this.cnf.auth.type="user")}messageHandler(t){"catalogue"===t?.type&&t?.data?.id===this.cnf.id&&this.emit("change",t.data)}api(t,e){return this.cnf.path?p.api.call({host:this.cnf.host,basePath:this.cnf.path,auth:this.cnf.auth,path:t,params:e}):Promise.reject(new Error("path is required"))}id(){return this.cnf.id}brands(t){return this.api("/brands",t)}brand(t,e){return this.api("/brands/"+t,e)}types(t){return this.api("/types",t)}type(t,e){return this.api("/types/"+t,e)}categories(t){return this.api("/categories",t)}category(t,e){return this.api("/categories/"+t,e)}items(t){return this.api("/items",t)}item(t,e){return this.api("/items/"+t,e)}itemTags(){return this.api("/items/tags")}pricelists(t){return this.api("/pricelists",t)}pricelist(t,e){return this.api("/pricelists/"+(t||"default"),e)}currencies(){return this.api("/currencies")}attributes(t){return this.api("/attributes",t)}attribute(t,e){return this.api("/attributes/"+t,e)}menus(t){return this.api("/menus",t)}menu(t,e){return this.api("/menus/"+t,e)}schedules(t){return this.api("/schedules",t)}scheduledItems(t,e){return this.api("/schedules/"+t+"/items",e)}schedule(t){return!t&&p.place?.catalogues?.[this.id()]&&(t=p.place.catalogues[this.id()].scheduleid),new b(this,t||"default")}overrides(t){return p.place.overrides?this.api("/overrides",t):Promise.resolve()}destroy(){p.off("message",this.messageHandler),this.removeAllListeners()}static list(){const t=[];return p.place.inventory&&p.place.inventory.filter((t=>"Catalogue"===t.type)).forEach((e=>t.push(e))),p.content?.data&&Object.keys(p.content.data).forEach((e=>{"Catalogue"===p.content?.data?.[e]?.type&&t.push(p.content.data[e])})),t}static use(t){if(!t||"string"==typeof t){const e=w.list();e.length&&(t=t?e.find((e=>e.id===t)):e[0])}return new w(t)}}const T=w;class x extends n.EventEmitter{constructor(t,e){super(),this.feed=t,this.params=e||{active:!0,limit:"all"},this.data={},this.items=[],this.timeoutID=null,this.changeTimeoutID=null,this.changeHandler=this.changeHandler.bind(this),this.feed.on("change",this.changeHandler),this.offlineHandler=this.offlineHandler.bind(this),p.on("message",this.offlineHandler),this.key="feed-"+this.feed.id()+"-"+Object.keys(this.params).map((t=>t+"-"+this.params[t])).join("-"),this.watcher=p.shared.watch(this.key,(t=>this.update(t))),this.fetch()}changeHandler(){this.changeTimeoutID&&clearTimeout(this.changeTimeoutID),this.changeTimeoutID=setTimeout((()=>this.fetch()),Math.floor(1e3*Math.random()*2)+500)}offlineHandler(t){"connect"===t?.type&&t?.data?.offlineFor&&(t.data.offlineFor<3e4||setTimeout(this.changeHandler,Math.floor(1e3*Math.random()*10)))}at(t){return t&&(this.data.now=t),this}now(){return this.data.now?y(this.data.now,{zone:this.tz()}):p.display.now?y(p.display.now,{zone:this.tz()}):f.DateTime.local().setZone(this.tz())}tz(){return p.place.tz||null}fetch(){return p.shared.lock(this.key).then((t=>{if(!t)return;const e={...this.params};return(this.data.now||p.display.now)&&(e.date=this.now().toISODate()),e.date||(e.now=!0),e.include||(e.include="kind"),this.feed.api("/items",e).then((t=>{if(t?.status>=400)return;const e=t?.data||[];return JSON.stringify(e)!==JSON.stringify(this.items)?p.shared.set(this.key,e):void 0})).catch((t=>this.emit("error",t)))}))}update(t){t&&(this.items=t);const e=this.now(),r=this.items.filter((t=>!("news"===t.kind&&y(t.start)>e)&&!("events"===t.kind&&t.end&&y(t.end)<=e)));setTimeout((()=>this.emit("items",r)),0),this.refresh()}refresh(){this.timeoutID&&clearTimeout(this.timeoutID);const t=this.items?.[0]?.kind;if(!t)return;let e=0;if("news"===t&&(e=f.DateTime.local().plus({days:1}).startOf("day").toMillis()-Date.now()),"events"===t){const t=this.items.filter((t=>t.end&&y(t.end).toMillis()>Date.now())).map((t=>y(t.end).toMillis()));t.length&&(e=Math.min(...t)-Date.now())}e>0&&(this.timeoutID=setTimeout((()=>this.update()),e))}destroy(){this.timeoutID&&clearTimeout(this.timeoutID),this.changeTimeoutID&&clearTimeout(this.changeTimeoutID),this.removeAllListeners(),p.off("message",this.offlineHandler),this.feed&&this.feed.off("change",this.changeHandler),this.feed=null,this.params=null,this.data={},this.items=[],this.key=null,this.watcher.stop()}}const E=x;class k extends n.EventEmitter{constructor(t){super(),this.configure(t),this.messageHandler=this.messageHandler.bind(this),p.on("message",this.messageHandler)}configure(t){this.cnf={id:"",host:"",path:"",auth:{},...t},this.cnf.id&&!this.cnf.path&&(this.cnf.path="/v1/feeds/"+this.cnf.id),this.cnf.auth.key||p.device.key||(this.cnf.auth.type="user")}messageHandler(t){"feed"===t?.type&&t?.data?.id===this.cnf.id&&this.emit("change",t.data)}api(t,e){return this.cnf.path?p.api.call({host:this.cnf.host,basePath:this.cnf.path,auth:this.cnf.auth,path:t,params:e}):Promise.reject(new Error("path is required"))}id(){return this.cnf.id}items(t){return this.api("/items",t)}item(t,e){return this.api("/items/"+t,e)}itemTags(){return this.api("/items/tags")}attributes(t){return this.api("/attributes",t)}attribute(t,e){return this.api("/attributes/"+t,e)}watch(t){return new E(this,t)}destroy(){p.off("message",this.messageHandler),this.removeAllListeners()}static list(){const t=[];return p.place.inventory&&p.place.inventory.filter((t=>"Feed"===t.type)).forEach((e=>t.push(e))),p.content?.data&&Object.keys(p.content.data).forEach((e=>{"Feed"===p.content?.data?.[e]?.type&&t.push(p.content.data[e])})),t}static use(t){if(!t||"string"==typeof t){const e=k.list();e.length&&(t=t?e.find((e=>e.id===t)):e[0])}return new k(t)}}const S=k;function O(t){t.classList.add("draggable"),t.style.cursor="grab",t.style.userSelect="none";const e={x:0,y:0,w:null,h:null},r=r=>{r&&(Object.keys(r).forEach((t=>e[t]=r[t])),t.style.transform=e.x||e.y?"translate("+e.x+"px, "+e.y+"px)":"",t.style.width=e.w?e.w+"px":"",t.style.height=e.h?e.h+"px":"")},i=i=>{t.classList.add("dragging"),t.style.cursor="grabbing";const n="touchstart"===i.type?i.touches[0].clientX:i.x,s="touchstart"===i.type?i.touches[0].clientY:i.y,a=t.getBoundingClientRect(),o=n-e.x,h=s-e.y,c=Math.round(a.width),u=Math.round(a.height),l=Math.round(n-a.x),d=Math.round(s-a.y),p=l>c-18&&d>u-18;p&&(t.classList.add("resizing"),t.style.cursor="nwse-resize");const f=t=>{const i="touchmove"===t.type?t.touches[0].clientX:t.x,n="touchmove"===t.type?t.touches[0].clientY:t.y;r(p?{w:c+i-o-e.x,h:u+n-h-e.y}:{x:i-o,y:n-h})},m=()=>{t.classList.remove("dragging"),t.classList.remove("resizing"),t.style.cursor="grab",window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",m),window.removeEventListener("touchmove",f),window.removeEventListener("touchend",m),t.dispatchEvent(new CustomEvent("change",{bubbles:!0,detail:e}))};window.addEventListener("mousemove",f),window.addEventListener("mouseup",m),window.addEventListener("touchmove",f),window.addEventListener("touchend",m)};return t.addEventListener("mousedown",i),t.addEventListener("touchstart",i),t.addEventListener("dblclick",(()=>r({x:0,y:0,w:null,h:null}))),[e,r]}let D;function P(){if(D)return D;D=new n.EventEmitter,p.once("ready",(()=>{setTimeout((()=>document.documentElement.classList.add("loaded")),32),p.env.messageEditing&&(document.documentElement.classList.add("editing"),document.querySelector("[data-layout]")&&p.send({type:"interactive"}))})),p.on("play",(()=>{document.querySelectorAll("[data-video]").forEach((t=>{t.currentTime=0,t.play()})),document.documentElement.classList.add("play"),document.documentElement.classList.remove("stop")})),p.on("stop",(()=>{document.documentElement.classList.add("stop")})),p.on("stopped",(()=>{setTimeout((()=>{p.playing||(document.documentElement.classList.remove("play","stop"),document.querySelectorAll("[data-video]").forEach((t=>{t.currentTime=0,t.pause()})))}),16)})),p.on("data",(e=>t(e.data)));const t=t=>{(t||[]).forEach((t=>{const i=document.querySelector('[data-field="'+t.key+'"]')||document.querySelector('[data-image="'+t.key+'"]')||document.querySelector('[data-paragraphs="'+t.key+'"]')||document.querySelector('[data-html="'+t.key+'"]')||document.querySelector('[data-cssvar="'+t.key+'"]')||document.querySelector('[data-layout="'+t.key+'"]');if(D.listenerCount("field-"+t.key))return D.emit("field-"+t.key,t,i,p);if(i)switch(t.type){case"json":break;case"bool":t.value?i.classList.add(t.key):i.classList.remove(t.key);break;case"content":{let e=t.value?.checksum?"../"+t.value.checksum:null;if(e&&p.env.preview&&t.value?.preview?.url&&(e=t.value.preview.url),!e&&"string"==typeof t.value&&t.value&&(e=t.value),!e&&i.hasAttribute("data-default")&&(e=i.getAttribute("data-default")),i.hasAttribute("data-image")&&i.getAttribute("data-image")===t.key){i.style.backgroundImage=e?"url("+e+")":"";break}const r=i.firstChild;if(r&&e&&r.getAttribute("data-url")===e)break;if(r&&r.remove(),e){let r=null;"Video"===t.value?.type?(r=document.createElement("video"),r.preload="auto",r.muted=!0,r.loop=!0,r.setAttribute("data-video",""),p.playing&&(r.autoplay=!0)):r=document.createElement("img"),r.setAttribute("data-url",e),r.src=e,i.appendChild(r)}break}case"textarea":if(i.hasAttribute("data-html")&&i.getAttribute("data-html")===t.key){i.innerHTML=t.value;break}if(i.hasAttribute("data-paragraphs")&&i.getAttribute("data-paragraphs")===t.key){i.innerHTML=r(t.value).map((t=>"<p>"+e(t)+"</p>")).join("");break}default:if(i.hasAttribute("data-cssvar")&&i.getAttribute("data-cssvar")===t.key){t.value?i.style.setProperty("--"+t.key,t.value):i.style.removeProperty("--"+t.key);break}i.textContent=t.value||""}}))};document.querySelectorAll("[data-layout]").forEach((t=>{const e=t.getAttribute("data-layout"),[r,i]=O(t);D.on("field-"+e,(t=>i(t.value))),t.addEventListener("change",(()=>p.send({type:"preview",data:{fields:{[e]:r}}})))}));const e=t=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return(t||"").replace(/[&<>"']/g,(t=>e[t]))},r=t=>(t||"").trim().split(/\n\s*\n/g).map((t=>t.trim())).filter((t=>!!t)),i=t=>fetch(t).then((t=>t.json())).then((t=>fetch(t["_si9n.json"]||"si9n.json").then((t=>t.json())).then((e=>{p.receive({data:{type:"configure",data:{content:{...e,data:t}}}})}))));if(0===location.search.indexOf("?test")){document.documentElement.classList.add("testing");let t=location.search.substr(1).split("&")[0].split(".")[0];-1===t.indexOf(".json")&&(t+=".json"),i(t).then((()=>{setTimeout((()=>p.receive({data:{type:"play"}})),128)}))}return p.once("configured",(t=>{p.env.thumbnail&&(t?.data?.content?.data||i("thumb.json").catch((()=>{})))})),D.render=t,D.e=e,D.lines=t=>(t||"").split(/[\r\n]+/).map((t=>t.trim())).filter((t=>!!t)),D.paragraphs=r,D}const I=p})();var h=o.tZ,c=o.fR,u=o.ZP,l=o.O1,d=o.yQ;export{h as Catalogue,c as Feed,u as default,l as useDraggable,d as useTemplate};