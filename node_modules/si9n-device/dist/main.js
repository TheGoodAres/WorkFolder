module.exports=function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s.h="92e610124502f876518e",s.cn="main",s(s.s=20)}([function(t,e){t.exports=require("path")},function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("os")},function(t,e){t.exports=require("superagent")},function(t,e){t.exports=require("child_process")},function(t,e){t.exports=require("serialport")},function(t,e){t.exports=require("crypto-js/hmac-md5")},function(t,e){t.exports=require("nedb")},function(t,e){t.exports=require("express")},function(t,e){t.exports=require("cors")},function(t,e){t.exports=require("eventemitter2")},function(t,e){t.exports=require("socket.io-client")},function(t,e){t.exports=require("extract-zip")},function(t,e){t.exports=require("dgram")},function(t,e){t.exports=require("@serialport/parser-readline")},function(t,e){t.exports=require("net")},function(t,e){t.exports=require("set-cookie-parser")},function(t,e,s){var i=s(4).exec,a=s(2),r=[];e.getDrives=function(t){switch(r=[],a.platform().toLowerCase()){case"win32":i("wmic logicaldisk get Caption,FreeSpace,Size,VolumeSerialNumber,Description,VolumeName  /format:list",(function(e,s,i){if(e)return t(e,null);for(var a=s.split("\r\r\n"),n=!1,o="",l="",h="",d="",c="",u=0;u<a.length;u++)if(""!=a[u]){var p=a[u].split("=");switch(p[0]){case"Caption":o=p[1],n=!0;break;case"Description":l=p[1];break;case"FreeSpace":h=p[1];break;case"Size":d=p[1];break;case"VolumeSerialNumber":p[1];break;case"VolumeName":c=p[1]}}else if(n){d=parseFloat(d),isNaN(d)&&(d=0),h=parseFloat(h),isNaN(h)&&(h=0);var f=d-h,y="0%";""!=d&&parseFloat(d)>0&&(y=Math.round(parseFloat(f)/parseFloat(d)*100)+"%"),r[r.length]={filesystem:l,blocks:d,used:f,available:h,capacity:y,mounted:o+"\\\\",name:c},n=!1,o="",l="",h="",d="","",c=""}return null!=t&&t(null,r),r}));break;case"linux":default:i("df -P | awk 'NR > 1'",(function(e,s,i){if(e)return t(e,null);for(var a=s.split("\n"),n=0;n<a.length;n++){var o=a[n];if(""!=o){var l=(o=o.replace(/ +(?= )/g,"")).split(" ");r[r.length]={filesystem:l[0],blocks:l[1],used:l[2],available:l[3],capacity:l[4],mounted:l.slice(5,l.length+1).join(" ")}}}return null!=t&&t(null,r),r}))}}},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("url")},function(t,e,s){"use strict";s.r(e);var i=s(4),a=s.n(i),r=s(0),n=s.n(r),o=s(2),l=s.n(o),h=s(10);class d extends h.EventEmitter2{constructor(t){super(),this.data=Object.assign({},this.defaults(),t||{})}defaults(){return{}}error(t){if(this.data.name)return console.error(this.data.name,t);console.error(t)}static create(t){return new this(t)}}var c=d,u=s(6),p=s.n(u),f=s(11),y=s.n(f);var g=class extends c{defaults(){return{version:null,enabled:!0,org:null,uuid:null,secret:null,url:null,webSocketsOnly:!0,path:"/rt",query:{org:null,uuid:null,sig:null},reconnectInterval:2592e5+Math.floor(1e3*Math.random()*60*60*4)}}constructor(t){super(t),this.socket=null,this.configure(t)}configure(t){!t||this.data.url===t.url&&this.data.enabled===t.enabled&&this.data.version===t.version&&this.socket||(t&&Object.assign(this.data,t),this.open())}open(){if(this.close(),!this.data.url||!this.data.enabled)return;this.data.query.org=this.data.org||"",this.data.query.uuid=this.data.uuid,this.data.query.sig=this.generateSignature();let t={path:this.data.path,forceNew:!0,query:this.data.query};this.data.webSocketsOnly&&(t.transports=["websocket"]),this.socket=y.a.connect(this.data.url,t),this.socket.on("connect",(()=>this.emit("connect",{type:"connect"}))),this.socket.on("disconnect",(()=>this.emit("disconnect",{type:"disconnect"}))),this.socket.on("message",(t=>{t.type&&this.emit(t.type,{type:t.type,data:t.data})})),this.socket.on("error",(t=>"unregister"===t?this.emit("unregister",{type:"unregister"}):"not enabled"===t?this.emit("fetch",{type:"fetch"}):void this.emit("error",{type:"error",data:t}))),this.socket.on("reconnect_attempt",(()=>{this.data.query.sig=this.generateSignature(),this.socket.io.opts.query=this.data.query})),this.timeoutID=setTimeout(this.open.bind(this),this.data.reconnectInterval)}close(){this.timeoutID&&clearTimeout(this.timeoutID),this.socket&&(this.socket.disconnect(),this.socket=null)}generateSignature(){const t=Math.round(Date.now()/1e3);return this.data.uuid&&this.data.secret?t+"-"+p()((this.data.org||"")+"|"+this.data.uuid+"|"+t,this.data.secret):""}},m=s(3),v=s.n(m),b=s(7),w=s.n(b);const k="function"==typeof v.a.agent?v.a.agent():v.a;var D=class extends c{defaults(){return{dbName:"si9n.Device",secretKey:"secret",confKey:"conf",registrationUrl:null,messageMap:{fetch:"fetchConf",unregister:"clearConf"},fetchDelay:3e3,lastFetchFailed:!1,disconnected:null,started:null,authed:null,authErrors:0,reauthInterval:432e6,fetchAfterOfflineFor:6e4,minPollInterval:3e5,isFetching:!1,cookies:null,authedConf:{}}}constructor(t){super(t),this.conf={},this.db=new w.a({filename:this.data.dbName,autoload:!0}),this.db.findOne({_id:this.data.secretKey},((t,e)=>{e&&e.data&&(this.conf.secret=e.data)})),this.data.started=Date.now(),this.data.disconnected=this.data.started,this.socket=g.create(),this.socket.onAny(((t,e)=>{if(e.type){if(this.data.messageMap&&this.data.messageMap[e.type]&&this[this.data.messageMap[e.type]](e.data),"disconnect"===e.type&&(this.data.disconnected=Date.now(),this.poll(),this.emit("log",{event:"Device.disconnect"})),"connect"===e.type&&this.data.disconnected){const t=Date.now()-this.data.disconnected;this.data.disconnected=null,(this.data.lastFetchFailed||t>this.data.fetchAfterOfflineFor)&&this.fetchConf(),this.poll(),this.emit("log",{event:"Device.connect",data:t>1e3?{offline:Math.round(t/1e3)}:null})}this.emit("message",e)}}))}poll(){this.pollID&&clearTimeout(this.pollID),!this.conf.poll||!this.conf.poll.interval||this.conf.poll.interval<this.data.minPollInterval||(this.pollID=setTimeout((()=>{this.data.disconnected&&(this.fetchConf(),this.poll())}),this.conf.poll.interval))}setup(t){t&&(this.conf.info=t),t&&this.emit("log",{event:"Device.setup",data:{name:t.name,version:t.version,ua:t.ua,...t.hostname&&{hostname:t.hostname},...t.network&&{network:t.network.filter((t=>!t.address.includes(":"))).map((t=>t.address))},...t.serial&&t.serial.length&&{serial:t.serial.map((t=>t.path))},...t.display&&t.display.length&&{display:t.display.map((t=>({w:t.bounds.width,h:t.bounds.height})))}}}),this.readConf((()=>{this.fetchID&&clearTimeout(this.fetchID),this.fetchID=setTimeout((()=>this.fetchConf()),this.data.fetchDelay)}))}readConf(t){this.db.findOne({_id:this.data.confKey},((e,s)=>{if(e)return t?t(e):null;s&&s.data&&this.configure(JSON.parse(s.data)),t&&t(!s||null)}))}writeConf(t,e){this.db.update({_id:this.data.confKey},{_id:this.data.confKey,data:JSON.stringify(t)},{upsert:!0},(t=>{if(t)return e?e(t):null;e&&e()}))}clearConf(t){this.db.remove({},{multi:!0},(e=>{t&&t(e)}))}fetchConf(t){if(this.data.isFetching)return this.once("fetched",(()=>this.fetchConf(t)));this.data.isFetching=!0;const e=e=>{e&&this.error(e),t&&t(e),this.data.isFetching=!1,this.data.lastFetchFailed=!!e,this.emit("fetched",{type:"fetched",target:this})};if(!this.data.authed&&this.conf.authUrls&&this.conf.authUrls.length)return this.auth((()=>{if(!this.data.authed)return e(new Error("could not auth"));this.data.isFetching=!1,this.fetchConf(t)}));const s=this.conf.url||this.data.registrationUrl;if(!s)return e(new Error("no url"));const i=this.conf.url?"GET":"POST";("POST"===i?k.post(s).send(this.conf.info):k.get(s).withCredentials()).end(((t,s)=>{if(t){if(!this.data.disconnected){const e=t.message&&t.message.startsWith("Request has been terminated")?"Request has been terminated":t.message;this.emit("log",{level:"error",event:"Device.fetch",data:t.status?{status:t.status}:{error:e}})}}else this.emit("log",{event:"Device.fetch"});if(!s||!s.ok)return e(t);if(!s.body)return e(new Error("no conf"));let a=s.body.data||s.body;if("POST"===i&&s.body.data.secret&&(a=s.body.data.conf,this.conf.secret=s.body.data.secret,this.db.update({_id:this.data.secretKey},{_id:this.data.secretKey,data:this.conf.secret},{upsert:!0})),!a.url)return e(new Error("bad conf or no conf.url"));this.conf.version&&a.version===this.conf.version&&!this.data.lastFetchFailed||(this.writeConf(a),this.configure(a)),e()}))}configure(t){t&&(delete this.conf.code,Object.assign(this.conf,t,this.data.authedConf),t.logging&&this.conf.logging&&(this.conf.logging={...this.conf.logging,...t.logging})),this.poll(),this.socket.configure(Object.assign({},this.conf.socket,{org:this.conf.org?this.conf.org.id:null,uuid:this.conf.id,secret:this.conf.secret}));const e=()=>this.emit("configure",{type:"configure",target:this});if(!this.data.authed)return this.auth(e);e()}auth(t){if(!this.conf.authUrls||!this.conf.authUrls.length)return this.data.authed=null,void(t&&t());const e={sig:this.signature(),app:this.conf.info.name,v:this.conf.info.version};this.conf.info.network&&this.conf.info.network.length&&(this.conf.info.network.forEach((t=>{t.address&&-1!==t.address.indexOf(".")&&"127.0.0.1"!==t.address&&(e.ip||(e.ip=[]),e.ip.push(t.address))})),e.ip&&(e.ip=e.ip.join(",")));let s=this.conf.authUrls.length;this.conf.authUrls.forEach((i=>{k.get(i).withCredentials().query(e).timeout(5e3).end(((e,i)=>{if(e){if(this.data.authErrors++,this.data.authErrors<10){const t=e.message&&e.message.startsWith("Request has been terminated")?"Request has been terminated":e.message;this.emit("log",{level:"error",event:"Device.auth",data:e.status?{status:e.status}:{error:t}})}}else this.data.authErrors=0,this.emit("log",{event:"Device.auth"});this.data.authed=e?null:Math.round(Date.now()/1e3),i&&i.headers&&i.headers.hasOwnProperty("set-cookie")&&(this.data.cookies=i.headers["set-cookie"]),i&&i.body&&i.body.data&&i.body.data.logging&&(this.data.authedConf=i.body.data,Object.assign(this.conf,this.data.authedConf)),s--,0===s&&t&&t()}))})),this.reauth()}signature(){const t=Math.round(Date.now()/1e3);return this.conf.id&&this.conf.secret?t+"-"+p()((this.conf.org.id||"")+"|"+this.conf.id+"|"+t,this.conf.secret):""}reauth(){this.reauthID&&clearTimeout(this.reauthID),this.data.reauthInterval&&(this.reauthID=setTimeout(this.auth.bind(this),this.data.reauthInterval))}close(){this.socket.close(),this.fetchID&&clearTimeout(this.fetchID),this.pollID&&clearTimeout(this.pollID),this.reauthID&&clearTimeout(this.reauthID)}},x=s(1),T=s.n(x),I=s(12),O=s.n(I);var E=class extends c{static isAvailable(){return!0}defaults(){return{directories:[],size:8589934592}}constructor(t){super(t),this.mkdir(this.data.directories,(()=>{this.emit("ready",{type:"ready",target:this})}))}read(t,e){T.a.readFile(t,e)}write(t,e,s,i){e instanceof ArrayBuffer&&(e=Buffer.from(e)),T.a.writeFile(t,e,(e=>{if(e)return i(e);this.get(t,i)}))}append(t,e,s,i){T.a.appendFile(t,e,i)}mkdir(t,e,s){if(!Array.isArray(t))return T.a.ensureDir(t,e);if(!t.length)return e?e():null;let i=t.length;t.forEach((t=>{this.mkdir(t,(()=>{i--,i>0||e&&e()}))}))}ls(t,e){T.a.readdir(t,((s,i)=>{if(s)return e(s);let a=i.length;if(!a)return e(null,[]);const r=()=>{a--,a>0||e(null,o)},o=[];i.forEach((e=>{const s={fullPath:n.a.join(t,e),name:e};o.push(s),T.a.stat(s.fullPath,((t,e)=>{if(t)return r();s.isDirectory=e.isDirectory(),s.isFile=e.isFile(),r()}))}))}))}rename(t,e,s){T.a.rename(t,n.a.join(n.a.dirname(t),n.a.basename(e)),s)}get(t,e){T.a.stat(t,((s,i)=>{if(s)return e(s);const a={fullPath:t,isDirectory:i.isDirectory(),isFile:i.isFile(),name:n.a.basename(t),toURL:()=>("file:///"+t).replace(/\\/g,"/").replace("file:////storage/sd/","file:///sd:/")},r={modificationTime:i.mtime,size:i.size};e(null,a,r)}))}getFile(t,e){const s={name:n.a.basename(t),localPath:t},i=!("undefined"==typeof process||!process.type||"renderer"!==process.type),a=navigator.userAgent.includes("BrightSign");(i||a)&&(s.blob=this.getBlob(t)),e(null,s)}remove(t,e){T.a.remove(t,e||(()=>{}))}clear(t,e){this.remove(t,(s=>{if(s)return!!e&&e(s);this.mkdir(t,e)}))}unzip(t,e,s){if(!(t instanceof ArrayBuffer))return O()(t,{dir:e},s);{const i=Buffer.from(t),a=e+"-"+Date.now()+".tmp";T.a.writeFile(a,i,(t=>{if(t)return s(t);this.unzip(a,e,(()=>{this.remove(a),s()}))}))}}createWriteStream(t,e){this.mkdir(n.a.dirname(t),(s=>{if(s)return e(s);e(null,T.a.createWriteStream(t))}))}pipe(t,e,s){const i=(t,e,s)=>{e.on("close",s),e.on("error",s),t.on("error",s),t.pipe(e)};if("string"!=typeof e)return i(t,e,s);this.createWriteStream(e,((e,a)=>{if(e)return s(e);i(t,a,s)}))}usage(t){t()}getBlob(t,e){if(!window||!window.Blob)return null;const s=T.a.readFileSync(t);return new window.Blob([new Uint8Array(s)],e?{type:e}:null)}error(t){this.emit("error",{type:"error",target:this,error:t})}};var P=class extends c{defaults(){return{isReady:!1,isWriting:!1,isRotating:!1,isUploading:!1,writeInterval:2e4,uploadInterval:6e4,levels:["debug","info","notice","warning","error","critical","alert","emergency"],drop:["load","next","prev","play","pause","console","end"],enabled:["event","playback"],doNotUpload:[],daysToKeep:90,daily:[],hourly:[],hours:[2,7,12,17,22],hourlyLog:{},url:null,formData:{},directory:"logs",queue:[],uploadIntervalID:null,writeIntervalID:null,stopUploading:!1,failedUploads:0,failedUploadsLimit:10,uploadBatch:20,closed:!1}}constructor(t){super(t),this.write=this.write.bind(this),this.filesystem=t.FileSystem.create({directories:[this.data.directory]}),this.filesystem.on("ready",(()=>{this.data.isReady=!0,this.write(),this.scheduleUpload(),this.emit("ready",{type:"ready",target:this})}))}configure(t){t&&(this.data={...this.data,...t}),!0===this.data.stopUploading&&(this.data.stopUploading=!1,this.scheduleUpload()),this.clean()}add(t,e,s){this.data.enabled&&this.data.enabled.includes(t)&&("playback"===t&&this.data.drop&&s.event&&this.data.drop.includes(s.event)||s.log&&s.log.message&&s.log.message.length>1e3||this.data.queue.push({n:t,t:(new Date).toISOString(),l:e||"info",d:{...s}}))}scheduleUpload(){this.data.uploadIntervalID&&clearTimeout(this.data.uploadIntervalID),this.data.uploadIntervalID=setTimeout((()=>{this.rotateAndUpload((()=>this.scheduleUpload()))}),this.data.uploadInterval*(this.data.failedUploads||1))}write(){if(this.data.writeIntervalID&&clearTimeout(this.data.writeIntervalID),!this.data.queue.length||this.data.isRotating||this.data.isWriting)return void(this.data.closed||(this.data.writeIntervalID=setTimeout(this.write,this.data.writeInterval)));this.data.isWriting=!0;const t=this.data.queue.shift(),e=t.n;delete t.n;const s=this.data.directory+"/"+e+"-"+this.today()+".log",i=JSON.stringify(t)+"\n";this.filesystem.append(s,i,"text/plain",(()=>{this.data.isWriting=!1,this.write()}))}today(){const t=new Date,e=t.getMonth()+1,s=t.getDate();return t.getFullYear()+"-"+(e<10?"0":"")+e+"-"+(s<10?"0":"")+s}rotateAndUpload(t){if(this.data.stopUploading)return t("uploading stopped");this.rotate((e=>{if(e)return t(e);this.upload(t)}))}rotate(t){if(this.data.isRotating||this.data.isWriting)return t("already rotating");this.data.isRotating=!0;const e=e=>{this.data.isRotating=!1,t(e)};this.filesystem.ls(this.data.directory,((t,s,i)=>{if(t)return e(t);const a=this.today(),r=(new Date).getHours(),n=[],o=[];if(s.forEach((t=>{if(t.isDirectory)return;if("_"===t.name[0])return;const e=t.name.split("-")[0],s=t.name.replace(e,"").substr(1,10);if(!(this.data.doNotUpload.length&&this.data.doNotUpload.includes(e)||this.data.daily.length&&this.data.daily.includes(e)&&s===a&&1!==r)){if(this.data.hourly.length&&this.data.hourly.includes(e)){if(!this.data.hours.includes(r))return;if(this.data.hourlyLog[e]===r)return;n.includes(e)||n.push(e)}o.push(t)}})),!o.length)return e();n.forEach((t=>this.data.hourlyLog[t]=r));let l=o.length;o.forEach((t=>{const s="_"+t.name.split(".")[0]+"-"+Date.now()+".log";this.filesystem.rename(this.data.directory+"/"+t.name,s,(()=>{l--,0===l&&e()}))}))}))}upload(t){if(this.data.isUploading)return t("already uploading");this.data.isUploading=!0;const e=e=>{this.data.isUploading=!1,t(e)};if(!this.data.url)return e("no url set");this.filesystem.ls(this.data.directory,((t,s,i)=>{if(t)return e(t);const a=s.filter((t=>!t.isDirectory&&"_"===t.name[0])).slice(0,this.data.uploadBatch||10);if(!a.length)return e();let r=a.length;const n=()=>{r--,0===r&&e()};a.forEach((t=>{this.filesystem.getFile(t.fullPath,((e,s)=>{if(e)return n();const i=v()("POST",this.data.url);for(let t in this.data.formData)this.data.formData.hasOwnProperty(t)&&i.field(t,this.data.formData[t]);i.attach("file",s.blob||s.localPath||s,t.name.substr(1)),i.end(((e,s)=>{if(!s||!s.ok)return this.data.failedUploads++,this.data.failedUploads>this.data.failedUploadsLimit&&(this.data.stopUploading=!0),n();this.data.failedUploads=0,this.filesystem.remove(t.fullPath,n)}))}))}))}))}clean(){this.data.isReady&&this.data.doNotUpload.length&&this.data.daysToKeep&&this.filesystem.ls(this.data.directory,((t,e,s)=>{if(t)return;const i={};e.forEach((t=>{if(t.isDirectory)return;let e=t.name.split("-")[0];-1!==this.data.doNotUpload.indexOf(e)&&(i[e]||(i[e]=[]),i[e].push(t.name))}));for(let t in i){if(!i.hasOwnProperty(t))continue;i[t].sort();let e=i[t].length-this.data.daysToKeep;e<1||i[t].slice(0,e).forEach((t=>this.filesystem.remove(this.data.directory+"/"+t)))}}))}clear(){this.data.isReady&&this.filesystem.clear(this.data.directory,(()=>this.emit("cleared",{type:"cleared",target:this})))}close(){this.data.isReady&&(this.write(),this.data.writeIntervalID&&clearTimeout(this.data.writeIntervalID),this.data.uploadIntervalID&&clearTimeout(this.data.uploadIntervalID),this.data.closed=!0)}};var S=class extends c{defaults(){return{isReady:!1,isDownloading:!1,dbName:"si9n.Inventory",keepFor:432e3,directory:"inventory",content:{},cookies:null}}constructor(t){super(t),this.db=new w.a({filename:this.data.dbName,autoload:!0}),this.filesystem=t.FileSystem.create({directories:[this.data.directory]}),this.filesystem.on("ready",(()=>{this.data.isReady=!0,this.emit("ready",{type:"ready",target:this}),this.data.content.length&&this.configure()}))}configure(t){if(t&&this.data.isDownloading)return this.once("update",(()=>this.configure(t)));t&&Object.assign(this.data,t),this.data.isReady&&(this.tidy((()=>this.download())),this.clean())}download(){if(!this.data.isReady||!this.data.content||this.data.isDownloading)return;this.data.isDownloading=!0;const t=[];Object.keys(this.data.content).forEach((e=>{this.data.content[e].hasOwnProperty("checksum")&&t.push(this.data.content[e])}));let e=t.length;const s=()=>{e--,e>0||(this.data.isDownloading=!1,this.emit("update",{type:"update",target:this}))};if(!t.length)return s();t.forEach((t=>{let e=t.checksum;t.localUrl&&(e+="/"+t.localUrl),this.logAccess(t),this.filesystem.get(this.data.directory+"/"+e,((i,a,r)=>{if(!i&&r.size>0)return this.data.content[t.id].inventoryUrl=a.toURL(),s();this.emit("download",{type:"start",id:t.id,name:this.data.content[t.id].name}),this.downloadFile(t.url,this.data.directory+"/"+t.checksum,(i=>i?(this.emit("download",{type:"error",id:t.id,name:this.data.content[t.id].name,error:i}),this.emit("log",{level:"error",event:"Inventory.download",data:{url:t.url,filename:e,err:i}}),s()):(this.emit("download",{type:"complete",id:t.id,name:this.data.content[t.id].name}),this.emit("log",{event:"Inventory.download",data:{url:t.url,filename:e}}),this.filesystem.get(this.data.directory+"/"+e,((e,i)=>{i&&(this.data.content[t.id].inventoryUrl=i.toURL()),s()})))))}))}))}downloadFile(t,e,s){const i=!("undefined"==typeof process||!process.type||"renderer"!==process.type),a=navigator.userAgent.includes("BrightSign"),r=!(i||a||"undefined"==typeof process||!process.release||"node"!==process.release.name),n=navigator.userAgent.includes("(Web0S;"),o=e+"-"+Date.now()+".tmp",l=t=>{if(t)return s(t);this.filesystem.rename(o,e,s)};if(n){const e={};if(this.data.cookies&&this.data.cookies.length){const s=[];this.data.cookies.forEach((e=>{t.startsWith("https://"+e.domain+e.path)&&Object.keys(e.cookies).forEach((t=>{s.push(t+"="+encodeURIComponent(e.cookies[t]))}))})),s.length&&(e.Cookie=s.join("; "))}const s=Object.keys(this.data.content).reduce(((e,s)=>{const i=this.data.content[s];return i.url&&i.url===t?"HTML"===i.type:e}),!1),i=s?o+"-"+Date.now()+".tmp":o;return this.filesystem.download(t,i,e,(t=>t?l(t):s?this.filesystem.unzip(i,o,(t=>{if(t)return l(t);this.filesystem.remove(i),l()})):void l()))}if(r){const e=v()("GET",t);if(this.data.cookies&&this.data.cookies.length){let s=[];this.data.cookies.forEach((e=>{0===t.indexOf(e.url+e.path)&&s.push(e.name+"="+encodeURIComponent(e.value))})),s.length&&e.set("Cookie",s.join("; "))}let s;e.on("response",(t=>{if(!t||!t.ok)return e.abort(),l(t.status);s="application/zip"===t.header["content-type"]}));let i=o+"-"+Date.now()+".tmp";this.filesystem.pipe(e,i,(t=>t?l(t):s?this.filesystem.unzip(i,o,(t=>{if(t)return l(t);this.filesystem.remove(i),l()})):void this.filesystem.rename(i,o,(t=>{if(t)return l(t);l()}))))}else v()("GET",t).withCredentials().responseType(i||a?"arraybuffer":"blob").end(((t,e)=>!t||403!==t.status&&404!==t.status?e&&e.ok&&e.body?"application/zip"===e.header["content-type"]?this.filesystem.unzip(e.body,o,l):void this.filesystem.write(o,e.body,e.header["content-type"],l):l(t):l(t.status)))}item(t){return this.data.content[t]||null}logAccess(t){t.checksum&&this.db.update({_id:t.checksum},{_id:t.checksum,lastaccess:parseInt(Date.now()/1e3,10),isFile:!t.localUrl},{upsert:!0})}tidy(t){this.filesystem.ls(this.data.directory,((e,s)=>{if(e)return t(e);const i=s.filter((t=>".tmp"===t.fullPath.slice(-4)));if(!i||!i.length)return t();let a=i.length;const r=()=>{a--,a<1&&t()};i.forEach((t=>this.filesystem.remove(t.fullPath,r)))}))}clean(){const t=[];Object.keys(this.data.content).forEach((e=>{this.data.content[e].checksum&&t.push(this.data.content[e].checksum)}));const e=parseInt(Date.now()/1e3,10)-this.data.keepFor;this.db.find({lastaccess:{$lt:e}},((e,s)=>{if(e)return this.emit("log",{level:"error",event:"Inventory.clean",data:{err:e}});s.forEach((e=>{-1===t.indexOf(e._id)&&(this.db.remove({_id:e._id}),this.filesystem.remove(this.data.directory+"/"+e._id),this.emit("log",{event:"Inventory.clean",data:{removed:e._id}}))}))}))}clear(){this.data.isReady&&(this.db.remove({},{multi:!0}),this.filesystem.clear(this.data.directory,(()=>{this.emit("log",{event:"Inventory.clear"}),this.emit("cleared",{type:"cleared",target:this})})))}close(){}},M=s(8),U=s.n(M),C=s(9),j=s.n(C);const R=s(18),F=s(0),q=s(19);const L=(t,e)=>{e.sort(((t,e)=>t.isDirectory<e.isDirectory?1:t.isDirectory>e.isDirectory?-1:0));const s='<!doctype html>\n    <html>\n        <head>\n            <meta charset="utf-8">\n            <title></title>\n            <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">\n            <style>html { font-family: sans-serif; font-size: 12px}\n            a, a:visited, a:active { color: inherit}\n            a:hover { opacity: 0.5}\n            td { text-align: right; padding-right: 8px}\n            td:first-child { text-align: left}</style>\n        </head>\n        <body><table>{{list}}</table></body>\n    </html>',i=e.map((t=>'<tr><td><a href="./'+N(t.name)+'">'+N(t.name)+"</a></td><td>"+(t.size||"")+"</td><td>"+t.modified+"</td></tr>")).join(""),a=s.replace("{{list}}",i);t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Content-Length",Buffer.byteLength(a,"utf8")),t.end(a,"utf8")},N=t=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return(t||"").replace(/[&<>"']/g,(t=>e[t]))};var _=class extends c{defaults(){return{enabled:!1,host:null,port:8080,directory:null,cacheFor:31536e3,messaging:!0,messageKey:null,directoryListings:!0,content:null,device:null,mimeTypes:{},redirects:{}}}constructor(t){super(t),this.app=null,this.server=null,this.sockets=[],this.configure()}configure(t){let e=!1;if(t&&this.server&&["enabled","host","port","directory","messaging","directoryListings"].forEach((s=>{t[s]&&this.data[s]!==t[s]&&(e=!0)})),t&&""===t.port&&delete t.port,t&&Object.assign(this.data,t),t&&t.content&&(this.data.mimeTypes={},this.data.redirects={},Object.keys(this.data.content).forEach((t=>{const e=this.data.content[t];e.checksum&&e.mimeType&&(this.data.mimeTypes[e.checksum]=e.mimeType),e.redirects&&e.redirects.length&&e.redirects.forEach((t=>{t.path&&!this.data.redirects[t.path]&&(this.data.redirects[t.path]=e.checksum+"/"+(t.to||e.localUrl||""))}))}))),e)return this.restart();this.data.enabled&&(this.server&&!e||(this.app=U()(),this.app.set("env","production"),this.app.disable("x-powered-by"),this.app.use(j()()),this.app.options("*",j()()),this.app.use(U.a.json()),this.data.messaging&&this.app.post("/message",((t,e)=>this.data.messageKey&&t.body.key!==this.data.messageKey?e.status(401).end():t.body&&t.body.type?(this.emit("message",t.body),void e.json({ok:!0})):e.status(400).end())),this.data.messaging&&this.app.get("/info",((t,e)=>e.json(this.data.device))),this.app.use(((t,e,s)=>{if("GET"===t.method&&this.data.redirects[t.path])return e.redirect(302,"/inventory/"+this.data.redirects[t.path]);s()})),this.data.directory&&(this.app.use(U.a.static(this.data.directory,{setHeaders:(t,e,s)=>{if((-1!==e.indexOf(n.a.join(this.data.directory,"inventory"))||-1!==e.indexOf(n.a.join(this.data.directory,"logs")))&&(-1!==e.indexOf(n.a.join(this.data.directory,"inventory"))&&t.set("Cache-Control","max-age="+this.data.cacheFor),this.data.content)){const s=n.a.basename(e);Object.keys(this.data.content).forEach((e=>{const i=this.data.content[e];i.checksum&&i.checksum===s&&i.mimeType&&t.set("Content-Type",i.mimeType)}))}}})),this.data.directoryListings&&this.app.use(function(t){if(!t)throw new TypeError("root path required");const e=F.normalize(F.resolve(t)+F.sep);return function(t,s,i){if("GET"!==t.method&&"HEAD"!==t.method)return s.statusCode="OPTIONS"===t.method?200:405,s.setHeader("Allow","GET, HEAD, OPTIONS"),s.setHeader("Content-Length","0"),void s.end();const a=q.parse(t.url),r=decodeURIComponent(a.pathname),n=F.normalize(F.join(e,r));return~n.indexOf("\0")||(n+F.sep).substr(0,e.length)!==e?i(new Error("bad request")):void R.stat(n,(function(t,e){return t&&"ENOENT"===t.code?i():t?(t.status="ENAMETOOLONG"===t.code?414:500,i(t)):e.isDirectory()?void R.readdir(n,(function(t,e){if(t)return i(t);e.sort();let a=e.length;if(!a)return i();const r=()=>{a--,a>0||L(s,o)},o=[];e.forEach((t=>{const e={fullPath:F.join(n,t),name:t};o.push(e),R.stat(e.fullPath,((t,s)=>{if(t)return r();e.isDirectory=s.isDirectory(),e.isFile=s.isFile(),e.size=s.size,e.created=s.birthtime,e.modified=s.mtime,r()}))}))})):i()}))}}(this.data.directory))),this.app.use(((t,e,s)=>{e.status(404).send()})),this.app.use(((t,e,s,i)=>{this.emit("error",t),s.status(500).send()})),this.server=this.app.listen(this.data.port||0,this.data.host,(t=>{if(t)return this.emit("error",t);this.emit("ready")})),this.server.on("connection",(t=>{this.sockets.push(t),t.once("close",(()=>this.sockets.splice(this.sockets.indexOf(t),1)))}))))}url(){return this.data.enabled&&this.server?"http://"+(this.data.host||"127.0.0.1")+":"+this.port()+"/":""}port(){return this.server?this.server.address().port:null}close(t){if(!this.server)return t?t():null;this.server.close((()=>{t&&t()})),this.sockets.forEach((t=>t.destroy())),this.sockets=[],this.server=null,this.app=null}restart(){this.close(this.configure.bind(this))}clearCache(t){t&&t()}clear(t){t&&t()}},A=s(13),z=s.n(A);var K=class extends c{defaults(){return{enabled:!1,send:[],receive:[],address:"237.132.123.123",port:3038,loopback:!1,bufferSize:1048576,ttl:32,latency:0,minimumLatency:4,dynamicLatency:!0,latencyTestInterval:15e4,latencyTestIterations:6,latencyTestLimit:50,latencyTests:{},latencyTestResults:[],logErrors:!0,logEvents:!1,debug:!1,lastMessage:null}}constructor(t){super(t),this.socket=null,this.onReceive=this.onReceive.bind(this),this.configure(t)}configure(t){const e=!this.socket||this.data.address!=t.address||this.data.port!=t.port||this.data.loopback!=t.loopback||this.data.ttl!=t.ttl;if(t&&Object.assign(this.data,t),!this.data.enabled)return this.close();e&&this.open()}open(t){if(this.socket)return this.close((()=>this.open(t)));this.socket=z.a.createSocket("udp4"),this.socket.on("error",(e=>(this.error("udp.error: "+e),this.close(t)))),this.socket.on("message",this.onReceive),this.socket.on("listening",(()=>{this.socket.setMulticastLoopback(this.data.loopback),this.socket.setMulticastTTL(this.data.ttl);const e=l.a.networkInterfaces();Object.keys(e).forEach((t=>{e[t].forEach((t=>{"IPv4"!==t.family||t.internal||"0.0.0.0"===t.address||(this.socket.addMembership(this.data.address,t.address),this.log("addMembership",t.address))}))})),this.startTestingLatency(),t&&t(),this.emit("open",{type:"open"}),this.log("open")})),this.socket.bind(this.data.port)}close(t){if(!this.socket)return t?t():null;this.socket.close(),this.socket=null,t&&t(),this.emit("close",{type:"close"}),this.log("close")}send(t,e){return this.data.enabled?this.socket?t.type&&-1===this.data.send.indexOf(t.type)?e?e("not sending: "+t.type):null:(this.log("send",t),"string"!=typeof t&&(t=JSON.stringify(t)),this.data.lastMessage&&this.data.lastMessage===t?e?e("just received"):null:void this.socket.send(t,this.data.port,this.data.address,(t=>{if(t)return this.error("send: "+t),e?e(t):null;e&&e()}))):(this.error("send: no socket"),e?e("no socket"):null):e?e("not enabled"):null}onReceive(t,e){let s,i=t.toString();if("ack:"==i.substr(0,4)){const t=Date.now(),e=parseInt(i.substr(4),10);if(!this.data.latencyTests[e])return;const s=t-e;return this.recordLatency(s)}if("test:"==i.substr(0,5))return this.send(i.replace("test:","ack:"));this.data.lastMessage=i,setTimeout((()=>{i===this.data.lastMessage&&(this.data.lastMessage=null)}),32);try{s=JSON.parse(i)}catch(t){return this.error("bad message: "+i)}if(!s.type||-1===this.data.receive.indexOf(s.type))return this.log("receive ignored",s);this.log("received",s),this.emit("message",s)}startTestingLatency(){if(!this.data.enabled||!this.data.dynamicLatency||!this.data.send.length)return;for(let t=1;t<=this.data.latencyTestIterations;t++)setTimeout(this.testLatency.bind(this),1500*t);this.data.latencyTestInterval&&setTimeout(this.startTestingLatency.bind(this),this.data.latencyTestInterval)}testLatency(){if(!this.socket)return;const t=Date.now();this.data.latencyTests[t]=!0,this.send("test:"+t),setTimeout((()=>{delete this.data.latencyTests[t]}),5e3)}recordLatency(t){this.data.latencyTestResults.push(t),this.data.latencyTestResults.length>this.data.latencyTestLimit&&(this.data.latencyTestResults=this.data.latencyTestResults.slice(-this.data.latencyTestLimit)),this.data.dynamicLatency&&(this.data.latency=this.averageLatency()),this.log("recordLatency",{duration:t,latency:parseInt(t/2,10),avg:this.data.latency})}averageLatency(){const t=this.data.latencyTestResults.reduce(((t,e)=>t+e),0)/this.data.latencyTestResults.length;return parseInt(t/2,10)}latency(){return this.data.latency}delay(t){return!this.data.enabled||!this.data.send.length||!this.latency()||this.latency()<this.data.minimumLatency?t():setTimeout(t,this.latency())}log(t,e){if(this.data.debug&&console.log("MulticastSocket",t,e||""),!this.data.logEvents)return;const s={message:t};e&&(s.data=e),this.emit("log",{event:"MulticastSocket",data:s})}error(t){this.data.logErrors&&this.emit("log",{level:"error",event:"MulticastSocket",data:t}),super.error(t)}},B=s(5),W=s.n(B),H=s(14);var G=class extends c{defaults(){return{enabled:!1,send:[],receive:[],port:"COM1",baudRate:9600,highWaterMark:131072,logErrors:!0,logEvents:!1,debug:!1,reconnectInterval:5e3,lastError:null,lastMessage:null}}constructor(t){super(t),this.port=null,this.parser=null,this.reconnectID=null,this.configure(t)}list(t){B.SerialPort.list().then((e=>t(e))).catch((t=>this.error(t)))}configure(t){t&&(t=Object.assign(this.defaults(),t));const e=!this.port||this.data.port!=t.port||this.data.baudRate!=t.baudRate;if(t&&Object.assign(this.data,t),!this.data.enabled)return this.close();e&&this.open()}open(t){if(this.port)return this.close((()=>this.open(t)));this.data.enabled&&(this.port=new B.SerialPort({path:this.data.port,baudRate:this.data.baudRate,highWaterMark:this.cnf.highWaterMark},(e=>{e&&(this.error("open: "+e),this.close(t))})),this.port.on("open",(()=>{this.emit("open",{type:"open"}),this.log("open",this.data.port,!0),t&&t()})),this.port.on("close",(t=>{this.port=null,this.parser=null,this.emit("close",{type:"close"}),t?this.error("close: "+t):this.log("close",null,!0),this.reconnect()})),this.port.on("error",(t=>this.error("error: "+t))),this.data.send.length||this.data.receive.length?(this.parser=this.port.pipe(new H.ReadlineParser),this.parser.on("data",this.receive.bind(this))):this.port.on("data",(t=>{const e=[...t];e.length&&this.receive(e)})))}close(t){if(!this.port)return t?t():null;this.port.close((()=>{this.port=null,this.parser=null,t&&t(),this.reconnect()}))}reconnect(){this.reconnectID&&clearTimeout(this.reconnectID),this.data.enabled&&!this.port&&this.data.reconnectInterval&&(this.reconnectID=setTimeout((()=>this.open()),this.data.reconnectInterval))}send(t,e){if(!this.data.enabled)return e?e("not enabled"):null;if(!this.port)return this.error("send: no port"),e?e("no port"):null;if(Array.isArray(t))t=new Uint8Array(t);else{if(t.type&&-1===this.data.send.indexOf(t.type))return e?e("not sending: "+t.type):null;if(this.log("send",t),"string"!=typeof t&&(t=JSON.stringify(t)),this.data.lastMessage&&this.data.lastMessage===t)return e?e("just received"):null;t=(new TextEncoder).encode(t+"\n")}this.port.write(t,(t=>{t&&this.error("send: "+t),e&&this.port.drain((t=>e(t)))}))}receive(t){if(Array.isArray(t)){if(!this.data.receive.length&&!this.data.send.length)return this.log("received",t),void this.emit("message",{type:"message",data:{type:"serial",port:this.data.port,data:t}});t=(new TextDecoder).decode(new Uint8Array(t))}let e;t=t.trim(),this.data.lastMessage=t,setTimeout((()=>{t===this.data.lastMessage&&(this.data.lastMessage=null)}),32);try{e=JSON.parse(t)}catch(e){return this.error("bad message: "+t)}if(!e.type||-1===this.data.receive.indexOf(e.type))return this.log("receive ignored",e);this.log("received",e),this.emit("message",e)}log(t,e,s){if(this.data.debug&&console.log("SerialPort",t,e||""),!this.data.logEvents&&!s)return;const i={message:t};e&&(i.data=e),this.emit("log",{event:"SerialPort",data:i})}error(t){this.data.lastError!==t&&(this.data.lastError=t,this.data.logErrors&&this.emit("log",{level:"error",event:"SerialPort",data:t}),super.error(t))}},J=s(15),V=s.n(J);const $=/^win/.test(process.platform);var Y=class extends c{defaults(){return{displays:[],turnOnDelay:6e5,setInputDelay:3e3,logErrors:!0,logEvents:!1,debug:!1}}constructor(t){super(t),this.configure(t),this.queue=[],this.timeouts={}}configure(t){t&&Object.assign(this.data,this.defaults(),t),this.data.displays&&this.data.displays.length&&this.data.displays.forEach((t=>{!t.port&&t.ip&&t.type&&t.type.serial&&t.type.serial.port&&(t.port=t.type.serial.port),!t.baudRate&&t.type&&t.type.serial&&t.type.serial.baudRate&&(t.baudRate=t.type.serial.baudRate),t.port&&(t.serial&&t.serial.hasOwnProperty("receive")||!t.type||!t.type.serial||!t.type.serial.hasOwnProperty("receive")||(t.serial||(t.serial={}),t.serial.receive=t.type.serial.receive),t.serial&&t.serial.logEvents&&(this.data.logEvents=!0),t.serial&&t.serial.debug&&(this.data.debug=!0),t._sendMethod=/^[0-9]+$/.test(t.port.toString())?"socketCommand":"serialCommand",t._ips=(t.ip||"").split(/[\s,]+/).filter((t=>!!t)),t._ports=t.port.toString().split(/[\s,]+/).filter((t=>!!t)))}))}turnOn(t,e){void 0===t&&(t=!0);const s={cmd:t?"on":"off",...(e=e||{}).hasOwnProperty("index")&&{index:e.index}};this.send(s);const i=s.hasOwnProperty("index")?s.index:"all";this.timeouts[i]&&clearTimeout(this.timeouts[i]),this.timeouts[i]=setTimeout((()=>this.send(s)),this.data.turnOnDelay),t&&e.input&&setTimeout((()=>this.send({cmd:e.input,...e.hasOwnProperty("index")&&{index:e.index}})),this.data.setInputDelay)}send(t){if(this.data.displays&&this.data.displays.length&&t)return"string"==typeof t&&(t={cmd:t}),t.hasOwnProperty("touchKeyboard")?this.touchKeyboard(t.touchKeyboard):t.hasOwnProperty("on")?this.turnOn(t.on,t):void this.data.displays.forEach(((e,s)=>{if(t.hasOwnProperty("index")&&s!==t.index)return;if(!e._sendMethod)return;let i;t.raw?(i=t.raw,"string"==typeof t.raw&&(i=t.raw.split(/[\s,]+/).map((t=>parseInt(t,16))))):t.cmd&&(e.type&&e.type.serial&&e.type.serial.cmd&&e.type.serial.cmd[t.cmd]&&(i=e.type.serial.cmd[t.cmd]),e.serial&&e.serial.cmd&&e.serial.cmd[t.cmd]&&(i=e.serial.cmd[t.cmd])),i&&(this.log(t.cmd||t.raw),this[e._sendMethod](e,i,t.ips||t.ports))}))}socketCommand(t,e,s){t._ips.forEach(((i,a)=>{if(s&&s.length&&-1===s.indexOf(a))return;const r=V.a.connect({host:i||"localhost",port:t.port},(()=>{r.write(Buffer.from(e),(()=>r.end()))}));r.on("error",(t=>this.error(t)))}))}serialCommand(t,e,s){if(t.busy)return this.queue.push([t,e,s]);const i=t.serial&&t.serial.receive,a=t._ports.filter(((t,e)=>!s||!s.length||-1!==s.indexOf(e)));let r=a.length;const n=()=>{if(r--,!(r>0)&&(t.busy=!1,this.queue.length)){const t=this.queue.shift();this.serialCommand(t[0],t[1],t[2])}};if(!a.length)return n();t.busy=!0,a.forEach((s=>{const a=new W.a(s,{baudRate:t.baudRate||9600},(t=>{t&&this.error(t),n()}));if(i){const e=()=>{a.close(n),i.length&&(this.emit("message",{type:"message",data:{type:"display",data:{id:t.id,response:i}}}),this.log(i))};let s,i=[],r=setTimeout(e,t.serial.timeout||1e3);a.on("data",(a=>{i=[...i,...a],r&&clearTimeout(r),s&&clearTimeout(s),s=setTimeout(e,t.serial.interval||64)}))}a.write(Buffer.from(e),(t=>{t&&this.error(t),i||a.close(n)}))}))}touchKeyboard(t){$&&a.a.execFile(t?"./bin/show-touchkeyboard.exe":"./bin/hide-touchkeyboard.exe")}log(t,e,s){if(this.data.debug&&console.log("DisplayControl",t,e||""),!this.data.logEvents&&!s)return;const i={message:t};e&&(i.data=e),this.emit("log",{event:"DisplayControl",data:i})}error(t){this.data.logErrors&&this.emit("log",{level:"error",event:"DisplayControl",data:t}),super.error(t)}},Q=s(16),X=s.n(Q),Z=s(17),tt=s.n(Z);const et=/^win/.test(process.platform);var st=class extends c{defaults(){return{dataPath:n.a.join(l.a.homedir(),".si9n"),registrationUrl:"https://api.si9n.io/v1/devices/registrations",playerMessageMap:{fetch:"fetchConf",reload:"reload",restart:"restart",reboot:"reboot",stopExplorer:"stopExplorer",startExplorer:"startExplorer",close:"close",clear:"clear",unregister:"unregister",togglePlay:"togglePlay",play:"play",pause:"pause",restartPlayback:"restartPlayback",next:"next",prev:"prev",message:"message",highlight:"highlight",speak:"speak",displayMessage:"displayMessage",serialMessage:"serialMessage"}}}constructor(t){if(super(t),!this.data.dataPath)throw new Error("no dataPath specified");this.data.started=Date.now(),this.device=D.create({dbName:n.a.join(this.data.dataPath,".device"),registrationUrl:this.data.registrationUrl,messageMap:{}}),this.device.on("configure",(()=>{this.device.conf.inventory&&(this.device.conf.inventory.cookies=[]),this.device.data.cookies&&X.a.parse(this.device.data.cookies).forEach((t=>{t.url="http"+(t.secure?"s":"")+"://"+t.domain,this.device.conf.inventory&&this.device.conf.inventory.cookies.push(t)})),this.configure(this.device.conf)})),this.device.on("log",(t=>this.log(t.level,t.event,t.data))),this.device.on("message",(t=>{this.data.playerMessageMap[t.type]&&this[this.data.playerMessageMap[t.type]](t.data),t.type&&-1!==["connect","disconnect"].indexOf(t.type)&&this.emit(t.type,t)})),this.logger=P.create({FileSystem:E,directory:n.a.join(this.data.dataPath,"logs")}),this.inventory=S.create({FileSystem:E,dbName:n.a.join(this.data.dataPath,".inventory"),directory:n.a.join(this.data.dataPath,"inventory")}),this.inventory.on("log",(t=>this.log(t.level,t.event,t.data))),this.inventory.on("ready",this.setup.bind(this)),this.inventory.on("download",(t=>this.message({type:"download",data:t}))),this.inventory.on("update",(()=>{this.data.inventory=this.inventory.data,Object.keys(this.data.inventory.content).forEach((t=>{let e=this.data.inventory.content[t];if("HTML"!==e.type||!e.inventoryUrl||e.proxyUrl||!this.webServer.url())return;const s=new RegExp("^file:.+?"+this.data.dataPath.replace(/\\/g,"/")+"/","gi");e.proxyUrl=e.inventoryUrl.replace(s,this.webServer.url())})),this.configureDisplays()}));const e=t=>{t.type&&-1===["unregister"].indexOf(t.type)&&this.data.playerMessageMap[t.type]&&this[this.data.playerMessageMap[t.type]](t.data)};this.webServer=_.create({directory:this.data.dataPath}),this.webServer.on("message",e),this.multicast=K.create(),this.multicast.on("log",(t=>this.log(t.level,t.event,t.data))),this.multicast.on("message",e),this.serial=G.create(),this.serial.on("log",(t=>this.log(t.level,t.event,t.data))),this.serial.on("message",e),this.displayControl=Y.create(),this.displayControl.on("log",(t=>this.log(t.level,t.event,t.data))),this.displayControl.on("message",e)}setup(){let t={name:"Si9n Device",version:"2.1.14",node:process.version,hostname:l.a.hostname(),ua:"Node.js "+process.version};this.serial.list((e=>t.serial=e)),t.platform={os:process.platform,arch:process.arch},t.cpu=l.a.cpus(),t.memory={capacity:l.a.totalmem(),availableCapacity:l.a.freemem()},t.network=[];const e=l.a.networkInterfaces();Object.keys(e).forEach((s=>{let i=!1;e[s].forEach((t=>{"IPv4"===t.family&&(i=!0),"127.0.0.1"===t.address&&(i=!1)})),i&&e[s].forEach((e=>{e.name=s,t.network.push(e)}))})),tt.a.getDrives(((e,s)=>{e||(t.storage=s),this.device.setup(t)}))}configure(t){this.log("info","Player.configure",t?{id:t.id,v:t.version}:null),t&&(delete this.data.code,Object.assign(this.data,t)),this.logger.configure(this.data.logging),this.webServer.configure({...this.data.webServer,content:this.data.inventory&&this.data.inventory.content,device:{id:this.data.id,name:this.data.name,app:this.data.app,type:this.data.type}}),this.multicast.configure(this.data.multicast),this.serial.configure(this.data.serial),this.displayControl.configure({displays:this.data.displays}),this.inventory.configure(this.data.inventory),this.data.inventory||this.configureDisplays(),t&&!t.hasOwnProperty("reboot")&&delete this.data.reboot,this.dailyReboot()}dailyReboot(){if(this.rebootTimeout&&clearTimeout(this.rebootTimeout),!this.data.reboot)return;const t=Date.now(),[e,s=0,i=0]=this.data.reboot.split(":");let a=(new Date).setHours(parseInt(e),parseInt(s),parseInt(i));(a<t||a-this.data.started<12e4)&&(a+=864e5),a-=6e5;let r=a-t;a<t?this.rebootTimeout=setTimeout(this.dailyReboot.bind(this),r):(a+=6e5,r=a-t,this.rebootTimeout=setTimeout(this.restart.bind(this),r))}configureDisplays(){this.emit("configured",{type:"configured",data:this.data})}send(t,e,s){let i={type:t};null!=e&&(i.data=e),this.multicast.send(i),this.serial.send(i),this.emit(t,i)}speak(t){this.send("speak",t,0)}highlight(){this.send("highlight")}togglePlay(){this.send("togglePlay")}play(){this.send("play")}pause(){this.send("pause")}restartPlayback(){this.send("restartPlayback")}next(t){this.send("next",t)}prev(){this.send("prev")}message(t){this.send("message",t)}displayMessage(t){this.displayControl.send(t)}serialMessage(t){this.serial&&t&&t.port&&t.data&&t.data.length&&this.serial.data.port===t.port&&this.serial.send(t.data)}fetchConf(){this.device.fetchConf()}clear(){this.logger.clear(),this.inventory.clear(),this.webServer.clear(),this.emit("clear")}unregister(){this.device.clearConf(),this.clear(),this.emit("unregister")}reload(){this.log("info","Player.reload"),this.emit("reload")}restart(){this.reboot()}reboot(){this.log("info","Player.reboot"),this.close(),setTimeout((()=>a.a.exec(et?"shutdown /f /r /t 00":"sudo reboot")),1e3)}stopExplorer(){et&&a.a.exec("taskkill /f /IM explorer.exe")}startExplorer(){et&&a.a.exec('tasklist /fo csv /fi "imagename eq explorer.exe',((t,e,s)=>{e.trim().split("\r\n").length<2&&a.a.exec("start explorer.exe")}))}close(){this.closed||(this.closed=!0,this.multicast.close(),this.serial.close(),this.webServer.close(),this.inventory.close(),this.device.close(),this.log("info","Player.close"),this.logger.close(),this.emit("close"))}error(t){this.log("error","error",t),super.error(t)}log(t,e,s){if(!this.logger)return void console.log((new Date).toISOString(),e,s||"");const i={event:e};s&&(i.data=Object.assign({},s)),this.logger.add("event",t,i)}};e.default=st}]).default;